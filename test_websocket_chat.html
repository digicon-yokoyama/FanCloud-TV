<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat Test</title>
</head>
<body>
    <h1>WebSocket Chat Test</h1>
    <div>
        <button id="connectBtn">Connect to Chat</button>
        <button id="sendBtn" disabled>Send Test Message</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
    </div>
    <div id="status">Disconnected</div>
    <div id="messages" style="border: 1px solid #ccc; height: 300px; overflow-y: auto; margin-top: 10px; padding: 10px;">
    </div>

    <script>
        let socket = null;

        document.getElementById('connectBtn').addEventListener('click', () => {
            const wsUrl = 'ws://localhost:8000/ws/chat/test_room/';
            console.log('Connecting to:', wsUrl);
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = (e) => {
                console.log('WebSocket connected!');
                document.getElementById('status').textContent = 'Connected';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = false;
                addMessage('System', 'Connected to chat');
            };
            
            socket.onmessage = (e) => {
                console.log('Message received:', e.data);
                const data = JSON.parse(e.data);
                if (data.error) {
                    addMessage('Error', data.error);
                } else {
                    addMessage(data.username || 'Unknown', data.message);
                }
            };
            
            socket.onerror = (e) => {
                console.error('WebSocket error:', e);
                addMessage('Error', 'Connection error');
            };
            
            socket.onclose = (e) => {
                console.log('WebSocket closed');
                document.getElementById('status').textContent = 'Disconnected';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = true;
                addMessage('System', 'Disconnected from chat');
            };
        });

        document.getElementById('sendBtn').addEventListener('click', () => {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = {
                    message: 'Test message from ' + new Date().toLocaleTimeString()
                };
                console.log('Sending:', message);
                socket.send(JSON.stringify(message));
            }
        });

        document.getElementById('disconnectBtn').addEventListener('click', () => {
            if (socket) {
                socket.close();
            }
        });

        function addMessage(sender, message) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>