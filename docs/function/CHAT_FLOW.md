# ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ  ãƒ•ãƒ­ãƒ¼ï¼†ãƒ‡ãƒ¼ã‚¿ä¿å­˜ä»•æ§˜

## ğŸ“‹ ç›®æ¬¡

- [æ¦‚è¦](#æ¦‚è¦)
- [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
- [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼](#ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼)
- [ãƒ‡ãƒ¼ã‚¿ä¿å­˜ä»•æ§˜](#ãƒ‡ãƒ¼ã‚¿ä¿å­˜ä»•æ§˜)
- [WebSocketé€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«](#websocketé€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«)
- [å®Ÿè£…è©³ç´°](#å®Ÿè£…è©³ç´°)
- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)

## ğŸ“ æ¦‚è¦

FanCloud TVã®ãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã¯ã€WebSocketã‚’ä½¿ç”¨ã—ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚Django Channelsã‚’åŸºç›¤ã¨ã—ã€Redisã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªé…ä¿¡ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

## ğŸ— ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ å…¨ä½“æ§‹æˆ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    [ãƒ–ãƒ©ã‚¦ã‚¶]           [Django/Daphne]          [Redis]         [PostgreSQL]
        â”‚                      â”‚                     â”‚                 â”‚
        â”‚   WebSocket          â”‚                     â”‚                 â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                 â”‚
        â”‚                      â”‚                     â”‚                 â”‚
        â”‚                 [ChatConsumer]             â”‚                 â”‚
        â”‚                      â”‚                     â”‚                 â”‚
        â”‚                      â”œâ”€â”€â”€â”€â”€Channel Layerâ”€â”€â”¤                 â”‚
        â”‚                      â”‚                     â”‚                 â”‚
        â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€DB Accessâ”€â”€â”¤
        â”‚                      â”‚                     â”‚                 â”‚
```

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 1. åˆæœŸæ¥ç¶šãƒ•ãƒ­ãƒ¼

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ãƒ–ãƒ©ã‚¦ã‚¶ â†’ WebSocketæ¥ç¶šè¦æ±‚ â†’ Django Channels
                                              â†“
                                        ChatConsumer
                                              â†“
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚                   â”‚
                              èªè¨¼ãƒã‚§ãƒƒã‚¯        ãƒ«ãƒ¼ãƒ ç¢ºèª
                                    â”‚                   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â†“
                                      Redisã‚°ãƒ«ãƒ¼ãƒ—å‚åŠ 
                                              â†“
                                        æ¥ç¶šç¢ºç«‹
```

### 2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒ•ãƒ­ãƒ¼

```
[é€ä¿¡è€…]
    â”‚
    â”œâ”€â”€ 1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›
    â”‚
    â”œâ”€â”€ 2. WebSocketé€ä¿¡
    â”‚      {
    â”‚        "message": "ã“ã‚“ã«ã¡ã¯ï¼"
    â”‚      }
    â”‚
    â””â”€â”€â†’ [ChatConsumer]
            â”‚
            â”œâ”€â”€ 3. æ¨©é™ç¢ºèª
            â”‚      - ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
            â”‚      - é€ä¿¡æ¨©é™ãƒã‚§ãƒƒã‚¯
            â”‚
            â”œâ”€â”€ 4. ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆPostgreSQLï¼‰
            â”‚      - chat_chatmessage ãƒ†ãƒ¼ãƒ–ãƒ«
            â”‚      - ãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚­ãƒ¼ãƒå†…
            â”‚
            â””â”€â”€ 5. ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆï¼ˆRedisï¼‰
                    â”‚
                    â”œâ”€â”€â†’ [å—ä¿¡è€…A]
                    â”œâ”€â”€â†’ [å—ä¿¡è€…B]
                    â””â”€â”€â†’ [é€ä¿¡è€…ï¼ˆã‚¨ã‚³ãƒ¼ãƒãƒƒã‚¯ï¼‰]
```

### 3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãƒ•ãƒ­ãƒ¼

```
[Redis Channel Layer]
    â”‚
    â”œâ”€â”€ ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡
    â”‚
    â””â”€â”€â†’ [å„æ¥ç¶šè€…ã®ChatConsumer]
            â”‚
            â”œâ”€â”€ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            â”‚      {
            â”‚        "username": "streamer",
            â”‚        "message": "ã“ã‚“ã«ã¡ã¯ï¼",
            â”‚        "message_type": "message",
            â”‚        "timestamp": null
            â”‚      }
            â”‚
            â””â”€â”€â†’ [ãƒ–ãƒ©ã‚¦ã‚¶]
                    â”‚
                    â””â”€â”€ DOMæ›´æ–°ãƒ»è¡¨ç¤º
```

## ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ä»•æ§˜

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 

```sql
-- PostgreSQL: localhost ã‚¹ã‚­ãƒ¼ãƒï¼ˆãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰ï¼‰

-- ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE chat_chatroom (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) UNIQUE NOT NULL,
    stream_id INTEGER REFERENCES streaming_stream(id),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE chat_chatmessage (
    id SERIAL PRIMARY KEY,
    room_id INTEGER REFERENCES chat_chatroom(id) NOT NULL,
    user_id INTEGER REFERENCES accounts_user(id),
    content TEXT NOT NULL,
    message_type VARCHAR(20) DEFAULT 'message',
    is_deleted BOOLEAN DEFAULT false,
    is_pinned BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_chatmessage_room_created ON chat_chatmessage(room_id, created_at DESC);
CREATE INDEX idx_chatmessage_user ON chat_chatmessage(user_id);
```

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

#### ChatRoom

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| id | Integer | ä¸»ã‚­ãƒ¼ |
| name | String | ãƒ«ãƒ¼ãƒ åï¼ˆstream_{uuid}å½¢å¼ï¼‰ |
| stream | ForeignKey | é–¢é€£ã™ã‚‹ã‚¹ãƒˆãƒªãƒ¼ãƒ  |
| is_active | Boolean | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ |
| created_at | DateTime | ä½œæˆæ—¥æ™‚ |

#### ChatMessage

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| id | Integer | ä¸»ã‚­ãƒ¼ |
| room | ForeignKey | ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ  |
| user | ForeignKey | é€ä¿¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ |
| content | Text | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ |
| message_type | String | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¨®åˆ¥ |
| is_deleted | Boolean | å‰Šé™¤ãƒ•ãƒ©ã‚° |
| is_pinned | Boolean | ãƒ”ãƒ³ç•™ã‚ãƒ•ãƒ©ã‚° |
| created_at | DateTime | é€ä¿¡æ—¥æ™‚ |

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¨®åˆ¥

- `message` - é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- `system` - ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- `join` - å…¥å®¤é€šçŸ¥
- `leave` - é€€å®¤é€šçŸ¥
- `moderation` - ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é€šçŸ¥

## ğŸ”Œ WebSocketé€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```
ws://localhost:8000/ws/chat/stream_{stream_id}/
```

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼

```javascript
{
    "message": "é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
}
```

#### ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

```javascript
{
    "username": "é€ä¿¡è€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å",
    "message": "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡",
    "message_type": "message|system|join|leave",
    "timestamp": null  // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§è¿½åŠ 
}
```

### æ¥ç¶šãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«

1. **æ¥ç¶šç¢ºç«‹**
   - WebSocketãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯
   - èªè¨¼ç¢ºèªï¼ˆCookieãƒ™ãƒ¼ã‚¹ï¼‰
   - ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ å­˜åœ¨ç¢ºèª
   - Redisã‚°ãƒ«ãƒ¼ãƒ—å‚åŠ 

2. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€å—ä¿¡**
   - JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§é€å—ä¿¡
   - è‡ªå‹•çš„ã«ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
   - ã‚¨ãƒ©ãƒ¼æ™‚ã¯å€‹åˆ¥é€šçŸ¥

3. **æ¥ç¶šçµ‚äº†**
   - Redisã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰é›¢è„±
   - ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
   - å¿…è¦ã«å¿œã˜ã¦é€€å®¤é€šçŸ¥

## ğŸ”§ å®Ÿè£…è©³ç´°

### ChatConsumerï¼ˆapps/chat/consumers.pyï¼‰

```python
class ChatConsumer(AsyncWebsocketConsumer):
    """WebSocket consumer for live chat."""
    
    async def connect(self):
        # ãƒ†ãƒŠãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆ
        tenant = Tenant.objects.first()
        with schema_context(tenant.schema_name):
            # ãƒ«ãƒ¼ãƒ ç¢ºèªãƒ»ã‚°ãƒ«ãƒ¼ãƒ—å‚åŠ 
            
    async def receive(self, text_data):
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãƒ»ä¿å­˜ãƒ»é…ä¿¡
        
    async def disconnect(self, close_code):
        # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†
```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆtemplates/streaming/watch.htmlï¼‰

```javascript
// WebSocketæ¥ç¶š
const chatSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/chat/stream_' + streamId + '/'
);

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
chatSocket.send(JSON.stringify({
    'message': message
}));

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    // DOMæ›´æ–°å‡¦ç†
};
```

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### èªè¨¼ãƒ»èªå¯

1. **WebSocketèªè¨¼**
   - Cookieãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼
   - Djangoèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã¨é€£æº
   - æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ¥ç¶šæ‹’å¦

2. **æ¨©é™ãƒã‚§ãƒƒã‚¯**
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‰ã«æ¨©é™ç¢ºèª
   - BANãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ–ãƒ­ãƒƒã‚¯
   - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆå®Ÿè£…äºˆå®šï¼‰

### ãƒ‡ãƒ¼ã‚¿ä¿è­·

1. **XSSå¯¾ç­–**
   - HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
   - ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³

2. **SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–**
   - Django ORMã«ã‚ˆã‚‹è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
   - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª

3. **CSRFå¯¾ç­–**
   - WebSocketã¯Originãƒ˜ãƒƒãƒ€ãƒã‚§ãƒƒã‚¯
   - APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯CSRFãƒˆãƒ¼ã‚¯ãƒ³å¿…é ˆ

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

1. **æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**
   - Redis Channel Layerã«ã‚ˆã‚‹åˆ†æ•£
   - è¤‡æ•°ã®Daphneãƒ¯ãƒ¼ã‚«ãƒ¼å¯¾å¿œ

2. **ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°**
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥

3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–**
   - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é©åˆ‡ãªè¨­å®š
   - å¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å®šæœŸå‰Šé™¤

### ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

- WebSocketæ¥ç¶šæ•°ã®ç›£è¦–
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒ¬ãƒ¼ãƒˆã®ç›£è¦–
- ã‚¨ãƒ©ãƒ¼ç‡ã®è¿½è·¡
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ã®æ¸¬å®š

## âš¡ YouTubeLiveé¢¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ 

### ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½æ¦‚è¦

FanCloud TVã§ã¯ã€YouTubeLiveé¢¨ã®ä¸€æ™‚çš„ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

### ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
[è¦–è´è€…]
    â”‚
    â”œâ”€â”€ 1. ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    â”‚      {
    â”‚        "type": "reaction",
    â”‚        "stamp_id": 1,
    â”‚        "stamp_name": ":smile:",
    â”‚        "stamp_image_url": "/media/stamps/01_smile.svg"
    â”‚      }
    â”‚
    â””â”€â”€â†’ [ChatConsumer.handle_reaction]
            â”‚
            â”œâ”€â”€ 2. æ¨©é™ç¢ºèªãƒ»èªè¨¼ãƒã‚§ãƒƒã‚¯
            â”‚
            â”œâ”€â”€ 3. åˆ†æç”¨ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆPostgreSQLï¼‰
            â”‚      - streaming_streamreaction ãƒ†ãƒ¼ãƒ–ãƒ«
            â”‚      - localhostã‚¹ã‚­ãƒ¼ãƒå†…ï¼ˆãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰ï¼‰
            â”‚
            â””â”€â”€ 4. ä¸€æ™‚çš„ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é…ä¿¡ï¼ˆRedisï¼‰
                    â”‚
                    â”œâ”€â”€â†’ [å—ä¿¡è€…A] â†’ 3ç§’é–“ã®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¡¨ç¤º
                    â”œâ”€â”€â†’ [å—ä¿¡è€…B] â†’ 3ç§’é–“ã®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¡¨ç¤º
                    â””â”€â”€â†’ [é€ä¿¡è€…] â†’ 3ç§’é–“ã®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¡¨ç¤º
```

### ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 

```sql
-- PostgreSQL: localhost ã‚¹ã‚­ãƒ¼ãƒï¼ˆãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰ï¼‰

-- ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE streaming_streamreaction (
    id SERIAL PRIMARY KEY,
    stream_id INTEGER REFERENCES streaming_stream(id) NOT NULL,
    user_id INTEGER REFERENCES accounts_user(id) NOT NULL,
    stamp_id INTEGER REFERENCES chat_chatstamp(id) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX streaming_s_stream_0c7fc7_idx ON streaming_streamreaction(stream_id, created_at DESC);
CREATE INDEX streaming_s_stamp_i_26798f_idx ON streaming_streamreaction(stamp_id, created_at DESC);
```

### ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã®ç‰¹å¾´

1. **ä¸€æ™‚çš„è¡¨ç¤º**: ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«ã¯æ®‹ã‚‰ãšã€3-4ç§’ã§æ¶ˆãˆã‚‹
2. **ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ä¸Šéƒ¨ã§ä¸Šæ–¹å‘ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
3. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ **: WebSocketã«ã‚ˆã‚‹å³åº§ã®é…ä¿¡
4. **åˆ†æå¯èƒ½**: PostgreSQLã«å±¥æ­´ä¿å­˜ã§å¾Œã‹ã‚‰çµ±è¨ˆåˆ†æå¯èƒ½

### é‡è¦ãªæ³¨æ„äº‹é …

**âš ï¸ ã‚¹ã‚­ãƒ¼ãƒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®é‡è¦æ€§**

```python
# âŒ é–“é•ã„: publicã‚¹ã‚­ãƒ¼ãƒã§ç¢ºèª
StreamReaction.objects.count()  
# â†’ django.db.utils.ProgrammingError: relation "streaming_streamreaction" does not exist

# âœ… æ­£ã—ã„: ãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚­ãƒ¼ãƒã§ç¢ºèª
from django_tenants.utils import get_tenant_model
tenant = get_tenant_model().objects.get(schema_name='localhost')
connection.set_tenant(tenant)
StreamReaction.objects.count()  # â†’ æ­£å¸¸ã«å‹•ä½œ
```

**ãƒ‡ãƒ¼ã‚¿ç¢ºèªæ™‚ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:**

1. **"ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„"ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆ**:
   - ã‚¹ã‚­ãƒ¼ãƒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºèª (`connection.schema_name`)
   - `public`ã‚¹ã‚­ãƒ¼ãƒã§ã¯ãªã`localhost`ã‚¹ã‚­ãƒ¼ãƒã«åˆ‡ã‚Šæ›¿ãˆ
   - ãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰ãƒ¢ãƒ‡ãƒ«ã¯å¿…ãšãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚­ãƒ¼ãƒå†…ã«å­˜åœ¨

2. **ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ**:
   ```python
   # ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒç¢ºèª
   from django.db import connection
   print(f"ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ: {connection.schema_name}")
   
   # ãƒ†ãƒŠãƒ³ãƒˆã«åˆ‡ã‚Šæ›¿ãˆ
   from django_tenants.utils import get_tenant_model
   tenant = get_tenant_model().objects.get(schema_name='localhost')
   connection.set_tenant(tenant)
   
   # ãƒ‡ãƒ¼ã‚¿ç¢ºèª
   from apps.streaming.models import StreamReaction
   print(f"ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°: {StreamReaction.objects.count()}")
   ```

### åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚¿ãƒ³ãƒ—

- `:smile:` - 01_smile.svg
- `:surprise:` - 02_surprise.svg  
- `:cry:` - 03_cry.svg
- `:love:` - 04_love.svg
- `:scream:` - 05_scream.svg
- `:angry:` - 06_angry.svg

## ğŸš€ ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

- [ ] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½
- [x] ~~ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰æ©Ÿèƒ½~~ â†’ **å®Ÿè£…å®Œäº†**ï¼ˆYouTubeLiveé¢¨ï¼‰
- [ ] ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
- [ ] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¤œç´¢æ©Ÿèƒ½
- [ ] ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–ï¼ˆè‡ªå‹•ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
- [ ] ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ£ãƒƒãƒˆï¼ˆæŠ•ã’éŠ­ï¼‰æ©Ÿèƒ½
- [ ] ãƒãƒ£ãƒƒãƒˆãƒªãƒ—ãƒ¬ã‚¤æ©Ÿèƒ½
- [ ] å¤šè¨€èªå¯¾å¿œ

---

**ä½œæˆæ—¥**: 2025-09-01  
**æœ€çµ‚æ›´æ–°**: 2025-09-03  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.1.0