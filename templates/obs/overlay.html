<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, height=1080">
    <title>OBS Chat Overlay - {{ stream.title }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            width: 1920px;
            height: 1080px;
            background-color: #00FF00; /* OBS ã‚¯ãƒ­ãƒã‚­ãƒ¼ç”¨ã‚°ãƒªãƒ¼ãƒ³ãƒãƒƒã‚¯ */
            font-family: 'Noto Sans JP', Arial, sans-serif;
            overflow: hidden;
            position: relative;
        }
        
        /* ãƒ‹ã‚³ãƒ‹ã‚³å‹•ç”»é¢¨ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
        .chat-overlay-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .floating-chat-message {
            position: absolute;
            white-space: nowrap;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: slideRightToLeft 10s linear forwards;
            z-index: 1001;
        }
        
        /* é€šå¸¸ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .floating-chat-message.normal {
            font-size: 24px;
            color: #FFFFFF;
            background: rgba(0, 0, 0, 0.6);
            padding: 6px 12px;
            border-radius: 20px;
            backdrop-filter: blur(4px);
        }
        
        /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³/ã‚¹ã‚¿ãƒ³ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .floating-chat-message.reaction {
            font-size: 28px;
            color: #FFD700;
            background: rgba(255, 215, 0, 0.2);
            padding: 8px 16px;
            border-radius: 25px;
            border: 2px solid #FFD700;
            backdrop-filter: blur(4px);
        }
        
        /* å³ã‹ã‚‰å·¦ã¸ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes slideRightToLeft {
            0% {
                transform: translateX(1920px);
                opacity: 1;
            }
            5% {
                opacity: 1;
            }
            95% {
                opacity: 1;
            }
            100% {
                transform: translateX(-100%);
                opacity: 0;
            }
        }
        
        /* ã‚¹ã‚¿ãƒ³ãƒ—ç”»åƒ */
        .stamp-image {
            width: 32px;
            height: 32px;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®è‰²ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ */
        .username {
            margin-right: 8px;
        }
        
        .username.color-1 { color: #FF6B6B; }
        .username.color-2 { color: #4ECDC4; }
        .username.color-3 { color: #45B7D1; }
        .username.color-4 { color: #96CEB4; }
        .username.color-5 { color: #FECA57; }
        .username.color-6 { color: #FF9FF3; }
        .username.color-7 { color: #54A0FF; }
        .username.color-8 { color: #5F27CD; }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼ˆ1080pä»¥å¤–ï¼‰ */
        @media (max-height: 720px) {
            .floating-chat-message.normal { font-size: 18px; }
            .floating-chat-message.reaction { font-size: 22px; }
            .stamp-image { width: 24px; height: 24px; }
        }
        
        @media (max-height: 480p) {
            .floating-chat-message.normal { font-size: 14px; }
            .floating-chat-message.reaction { font-size: 18px; }
            .stamp-image { width: 20px; height: 20px; }
        }
        
        /* ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆæœ¬ç•ªã§ã¯å‰Šé™¤ï¼‰ */
        .debug-info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- OBSç”¨ãƒãƒ£ãƒƒãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="chat-overlay-container" id="chat-overlay-container">
        <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
    </div>
    
    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
    <div class="debug-info" id="debug-info" style="display: none;">
        <div>Stream: {{ stream.stream_id }}</div>
        <div>Status: <span id="connection-status">æ¥ç¶šä¸­...</span></div>
        <div>Messages: <span id="message-count">0</span></div>
    </div>

    <script>
        // WebSocketæ¥ç¶šè¨­å®š
        const streamId = '{{ stream.stream_id }}';
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = protocol + '//' + window.location.host + '/ws/chat/' + streamId + '/';
        
        let chatSocket = null;
        let messageCount = 0;
        let verticalPositions = []; // Yåº§æ¨™ç®¡ç†
        const messageHeight = 50; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é«˜ã•
        const maxMessages = 20; // åŒæ™‚è¡¨ç¤ºæœ€å¤§æ•°
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®è‰²ã‚’æ±ºå®šï¼ˆãƒãƒƒã‚·ãƒ¥ãƒ™ãƒ¼ã‚¹ï¼‰
        function getUsernameColor(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            return Math.abs(hash) % 8 + 1;
        }
        
        // Yåº§æ¨™ã‚’å–å¾—ï¼ˆé‡è¤‡å›é¿ï¼‰
        function getAvailableYPosition() {
            const maxY = 1080 - 100; // ç”»é¢ä¸‹éƒ¨ãƒãƒ¼ã‚¸ãƒ³
            const minY = 50; // ç”»é¢ä¸Šéƒ¨ãƒãƒ¼ã‚¸ãƒ³
            
            // åˆ©ç”¨å¯èƒ½ãªYåº§æ¨™ã‚’æ¢ã™
            for (let y = minY; y <= maxY; y += messageHeight) {
                if (!verticalPositions.includes(y)) {
                    verticalPositions.push(y);
                    // 10ç§’å¾Œã«è§£æ”¾
                    setTimeout(() => {
                        const index = verticalPositions.indexOf(y);
                        if (index > -1) {
                            verticalPositions.splice(index, 1);
                        }
                    }, 10000);
                    return y;
                }
            }
            
            // å…¨ã¦åŸ‹ã¾ã£ã¦ã„ã‚‹å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ 
            return Math.random() * (maxY - minY) + minY;
        }
        
        // è¨­å®šã‚’å–å¾—
        function getOverlaySettings() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                anonymous: urlParams.get('anonymous') === 'true' || {{ stream.obs_overlay_anonymous|yesno:"true,false" }},
                debug: urlParams.get('debug') === 'true'
            };
        }
        
        // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¡¨ç¤º
        function displayFloatingMessage(data) {
            const container = document.getElementById('chat-overlay-container');
            const messageElement = document.createElement('div');
            const settings = getOverlaySettings();
            
            const isReaction = data.type === 'reaction' || data.stamp_name;
            const yPosition = getAvailableYPosition();
            const username = data.username || 'Anonymous';
            const colorClass = `color-${getUsernameColor(username)}`;
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
            messageElement.className = `floating-chat-message ${isReaction ? 'reaction' : 'normal'}`;
            messageElement.style.top = yPosition + 'px';
            
            let content = '';
            
            if (isReaction) {
                // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³/ã‚¹ã‚¿ãƒ³ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                const stampImage = data.stamp_image_url ? 
                    `<img src="${data.stamp_image_url}" alt="${data.stamp_name}" class="stamp-image">` : 
                    '';
                
                if (settings.anonymous) {
                    // åŒ¿åãƒ¢ãƒ¼ãƒ‰: ã‚¹ã‚¿ãƒ³ãƒ—ã®ã¿è¡¨ç¤º
                    content = `${stampImage}`;
                } else {
                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: ãƒ¦ãƒ¼ã‚¶ãƒ¼å + ã‚¹ã‚¿ãƒ³ãƒ—
                    content = `<span class="username ${colorClass}">${username}</span>${stampImage}`;
                }
            } else {
                // é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (settings.anonymous) {
                    // åŒ¿åãƒ¢ãƒ¼ãƒ‰: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åãªã—ï¼‰
                    content = `${data.message || data.content}`;
                } else {
                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: ãƒ¦ãƒ¼ã‚¶ãƒ¼å + ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    content = `<span class="username ${colorClass}">${username}:</span>${data.message || data.content}`;
                }
            }
            
            messageElement.innerHTML = content;
            container.appendChild(messageElement);
            
            // 10ç§’å¾Œã«DOMã‹ã‚‰å‰Šé™¤
            setTimeout(() => {
                if (messageElement.parentNode) {
                    messageElement.parentNode.removeChild(messageElement);
                }
            }, 10000);
            
            // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
            messageCount++;
            document.getElementById('message-count').textContent = messageCount;
        }
        
        // WebSocketæ¥ç¶šé–‹å§‹
        function initializeWebSocket() {
            console.log('ğŸ”Œ OBS Overlay: Connecting to WebSocket:', wsUrl);
            
            chatSocket = new WebSocket(wsUrl);
            
            chatSocket.onopen = function(e) {
                console.log('ğŸ”Œ OBS Overlay: WebSocket connected successfully');
                document.getElementById('connection-status').textContent = 'æ¥ç¶šä¸­';
                document.getElementById('connection-status').style.color = '#4CAF50';
            };
            
            chatSocket.onmessage = function(e) {
                try {
                    const data = JSON.parse(e.data);
                    console.log('ğŸ”Œ OBS Overlay: Received message:', data);
                    
                    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                    if (data.error) {
                        console.error('ğŸ”Œ OBS Overlay: WebSocket error:', data.error);
                        return;
                    }
                    
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                    displayFloatingMessage(data);
                    
                } catch (err) {
                    console.error('ğŸ”Œ OBS Overlay: Failed to parse message:', err);
                }
            };
            
            chatSocket.onclose = function(e) {
                console.log('ğŸ”Œ OBS Overlay: WebSocket disconnected');
                document.getElementById('connection-status').textContent = 'åˆ‡æ–­';
                document.getElementById('connection-status').style.color = '#F44336';
                
                // 3ç§’å¾Œã«å†æ¥ç¶šè©¦è¡Œ
                setTimeout(initializeWebSocket, 3000);
            };
            
            chatSocket.onerror = function(e) {
                console.error('ğŸ”Œ OBS Overlay: WebSocket error:', e);
                document.getElementById('connection-status').textContent = 'ã‚¨ãƒ©ãƒ¼';
                document.getElementById('connection-status').style.color = '#FF9800';
            };
        }
        
        // è¨­å®šã«åŸºã¥ãåˆæœŸåŒ–
        function applyOverlaySettings() {
            const settings = getOverlaySettings();
            
            // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
            if (settings.debug) {
                document.getElementById('debug-info').style.display = 'block';
                
                // è¨­å®šçŠ¶æ³ã‚’è¡¨ç¤º
                const debugInfo = document.getElementById('debug-info');
                debugInfo.innerHTML += `<div>åŒ¿åãƒ¢ãƒ¼ãƒ‰: ${settings.anonymous ? 'ON' : 'OFF'}</div>`;
            }
            
            console.log('ğŸ¥ OBS Overlay Settings:', settings);
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            applyOverlaySettings();
            initializeWebSocket();
            
            console.log('ğŸ¥ OBS Chat Overlay initialized for stream:', streamId);
        });
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«WebSocketåˆ‡æ–­
        window.addEventListener('beforeunload', function() {
            if (chatSocket) {
                chatSocket.close();
            }
        });
    </script>
</body>
</html>