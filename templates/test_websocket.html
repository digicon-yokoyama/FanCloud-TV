{% extends 'base/base.html' %}

{% block title %}WebSocketèªè¨¼ãƒ†ã‚¹ãƒˆ{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>WebSocketèªè¨¼ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>æ¥ç¶šçŠ¶æ³</h5>
                </div>
                <div class="card-body">
                    <div id="status" class="alert alert-secondary">æœªæ¥ç¶š</div>
                    <button class="btn btn-success me-2" onclick="connect()">æ¥ç¶š</button>
                    <button class="btn btn-danger" onclick="disconnect()">åˆ‡æ–­</button>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</h5>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
                        <button class="btn btn-primary" onclick="sendMessage()">é€ä¿¡</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <h5>ãƒ­ã‚°</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">ã‚¯ãƒªã‚¢</button>
                </div>
                <div class="card-body">
                    <div id="log" style="height: 400px; overflow-y: scroll; background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let chatSocket = null;
    const roomName = 'test_room';
    
    // Cookieå–å¾—ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function log(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const colorClass = type === 'error' ? 'text-danger' : (type === 'success' ? 'text-success' : 'text-info');
        logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function updateStatus(status, type = 'secondary') {
        const statusDiv = document.getElementById('status');
        statusDiv.className = `alert alert-${type}`;
        statusDiv.textContent = status;
    }
    
    function connect() {
        if (chatSocket) {
            log('æ—¢ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã™', 'error');
            return;
        }
        
        // Cookieã®ç¢ºèª
        const cookies = document.cookie;
        log(`ç¾åœ¨ã®Cookie: ${cookies}`, 'info');
        
        // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®ç¢ºèªï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³IDã¯HttpOnlyã®ãŸã‚JSã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰
        const csrfToken = getCookie('csrftoken');
        
        log(`âœ… CSRFãƒˆãƒ¼ã‚¯ãƒ³: ${csrfToken ? csrfToken.substring(0, 10) + '...' : 'ãªã—'}`, 'info');
        log(`â„¹ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã¯HttpOnlyã®ãŸã‚JSå´ã§ã¯ç¢ºèªã§ãã¾ã›ã‚“`, 'info');
        
        // ChatConsumerã«æˆ»ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³å•é¡Œã‚’ãƒ†ã‚¹ãƒˆ
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsPath = `${wsScheme}://${window.location.host}/ws/chat/${roomName}/`;
        
        log(`ğŸ”§ ãƒ‡ãƒãƒƒã‚°: ChatConsumerã§ã‚»ãƒƒã‚·ãƒ§ãƒ³å•é¡Œã‚’ãƒ†ã‚¹ãƒˆ`, 'info');
        
        log(`æ¥ç¶šè©¦è¡Œ: ${wsPath}`);
        updateStatus('æ¥ç¶šä¸­...', 'warning');
        
        chatSocket = new WebSocket(wsPath);
        
        chatSocket.onopen = function(e) {
            log('WebSocketæ¥ç¶šæˆåŠŸï¼', 'success');
            updateStatus('æ¥ç¶šæ¸ˆã¿', 'success');
        };
        
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            log(`å—ä¿¡: ${JSON.stringify(data, null, 2)}`, 'success');
            
            if (data.error) {
                log(`ã‚¨ãƒ©ãƒ¼: ${data.error}`, 'error');
            }
            
            if (data.message_type === 'auth_error') {
                log('èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
                updateStatus('èªè¨¼ã‚¨ãƒ©ãƒ¼', 'danger');
            }
        };
        
        chatSocket.onclose = function(e) {
            log(`WebSocketåˆ‡æ–­ (code: ${e.code})`, 'error');
            updateStatus('åˆ‡æ–­æ¸ˆã¿', 'secondary');
            chatSocket = null;
        };
        
        chatSocket.onerror = function(e) {
            log('WebSocketã‚¨ãƒ©ãƒ¼', 'error');
            updateStatus('ã‚¨ãƒ©ãƒ¼', 'danger');
        };
    }
    
    function disconnect() {
        if (chatSocket) {
            chatSocket.close();
            chatSocket = null;
            updateStatus('åˆ‡æ–­æ¸ˆã¿', 'secondary');
            log('WebSocketåˆ‡æ–­');
        }
    }
    
    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if (!message) {
            log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
            return;
        }
        
        if (!chatSocket) {
            log('WebSocketã«æ¥ç¶šã—ã¦ãã ã•ã„', 'error');
            return;
        }
        
        if (chatSocket.readyState !== WebSocket.OPEN) {
            log('WebSocketæ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
            return;
        }
        
        // é€ä¿¡å‰ã®çŠ¶æ…‹ç¢ºèª
        log(`ğŸ” é€ä¿¡å‰ãƒã‚§ãƒƒã‚¯:`, 'info');
        log(`  - WebSocketçŠ¶æ…‹: ${chatSocket.readyState === WebSocket.OPEN ? 'OPEN' : 'NOT_OPEN'}`, 'info');
        log(`  - ã‚»ãƒƒã‚·ãƒ§ãƒ³: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç¢ºèª`, 'info');
        
        const data = {
            'message': message
        };
        
        log(`ğŸ“¤ é€ä¿¡: ${message}`, 'info');
        log(`ğŸ“¤ é€ä¿¡ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(data)}`, 'info');
        
        try {
            chatSocket.send(JSON.stringify(data));
            messageInput.value = '';
        } catch (error) {
            log(`âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        }
    }
    
    function clearLog() {
        document.getElementById('log').innerHTML = '';
    }
    
    // Enter keyã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®èª¬æ˜
    window.onload = function() {
        {% if user.is_authenticated %}
            log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿: {{ user.username }}', 'success');
            log('ã€Œæ¥ç¶šã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦WebSocketæ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„');
        {% else %}
            log('âŒ æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§ã™', 'error');
            log('ã¾ãš <a href="{% url "accounts:login" %}" target="_blank">ãƒ­ã‚°ã‚¤ãƒ³</a> ã—ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„');
        {% endif %}
        log('WebSocketèªè¨¼ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã§ã™');
    };
</script>
{% endblock %}
