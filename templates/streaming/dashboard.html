{% extends 'base/base.html' %}
{% load static %}

{% block title %}é…ä¿¡ç®¡ç† - {{ stream.title }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
:root {
    --light-bg: #f8f9fa;
    --card-bg: #ffffff;
    --border-color: #e0e0e0;
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --hover-bg: #f5f5f5;
}

.streaming-dashboard {
    background: var(--light-bg);
    min-height: calc(100vh - 76px);
    color: var(--text-primary);
}

.preview-section {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 0;
    position: relative;
    overflow: hidden;
}

.stream-preview {
    width: 100%;
    aspect-ratio: 16/9;
    background: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.preview-content {
    text-align: center;
    color: white;
}


.stream-status-indicator {
    position: absolute;
    top: 12px;
    left: 12px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    z-index: 5;
    color: white;
}

.status-created { background: #6c757d; }
.status-live { background: #6c757d; }
.status-ended { background: #6c757d; }
.status-error { background: #6c757d; }

.preview-info {
    padding: 16px;
    border-top: 1px solid var(--border-color);
    background: var(--card-bg);
    position: relative;
    z-index: 10;
}

.stream-help-text {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    margin-top: 16px;
    display: flex;
    align-items: center;
}

.stream-help-text i {
    margin-right: 8px;
    color: var(--text-secondary);
}

.settings-section {
    background: var(--card-bg);
    border-radius: 12px;
    height: fit-content;
}

.settings-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border-color);
}

.settings-body {
    padding: 24px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: var(--text-primary);
    font-size: 14px;
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    background: var(--light-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: var(--text-secondary);
    background: var(--light-bg);
    color: var(--text-primary);
}

.form-control::placeholder {
    color: var(--text-secondary);
}

.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23aaa' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
}

.viewer-count {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--text-secondary);
}

.live-indicator {
    width: 8px;
    height: 8px;
    background: var(--brand-red);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.dashboard-tabs {
    background: var(--card-bg);
    border-radius: 12px;
    margin-top: 24px;
    overflow: hidden;
}

.tab-nav {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
}

.tab-nav-item {
    padding: 16px 24px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    position: relative;
}

.tab-nav-item:hover {
    background: var(--hover-bg);
    color: var(--text-primary);
}

.tab-nav-item.active {
    color: var(--text-primary);
    border-bottom-color: var(--text-secondary);
}

.tab-content {
    display: none;
    padding: 24px;
}

.tab-content.active {
    display: block;
}

.stream-key-section {
    background: #f8f9fa;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 20px;
}

.input-group {
    display: flex;
    border-radius: 8px;
    overflow: hidden;
}

.input-group .form-control {
    border-radius: 0;
    border-right: none;
    flex: 1;
}

.input-group .btn {
    border-radius: 0;
    border: 1px solid var(--border-color);
    border-left: none;
}




.quality-selector {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.quality-option {
    display: flex;
    align-items: center;
    padding: 12px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.quality-option:hover {
    border-color: var(--text-secondary);
    background: var(--hover-bg);
}

.quality-option.selected {
    border-color: var(--text-primary);
    background: var(--hover-bg);
}

.quality-radio {
    margin-right: 12px;
    accent-color: var(--text-secondary);
}

.quality-info {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.quality-name {
    font-weight: 500;
    color: var(--text-primary);
}

.quality-desc {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 2px;
}

.action-buttons {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: flex-start;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border-color);
}

.toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
    background: #ccc;
    border-radius: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.toggle-switch.active {
    background: var(--text-secondary);
}

.toggle-switch::before {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: transform 0.2s;
}

.toggle-switch.active::before {
    transform: translateX(20px);
}

.setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 0;
    border-bottom: 1px solid var(--border-color);
}

.setting-row:last-child {
    border-bottom: none;
}

.setting-info h6 {
    margin: 0;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
}

.setting-info p {
    margin: 4px 0 0;
    font-size: 13px;
    color: var(--text-secondary);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.stat-label {
    font-size: 13px;
    color: var(--text-secondary);
}

/* Chat Management Styles */
.chat-control-bar {
    border: 1px solid var(--border-color);
}

.chat-messages-scroll {
    height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    background: var(--card-bg);
}

.chat-message {
    background: var(--card-bg);
    transition: background 0.2s;
    padding: 8px 12px;
    margin-bottom: 8px;
    border-radius: 6px;
    border: 1px solid transparent;
}

.chat-message:hover {
    background: var(--hover-bg);
    border-color: var(--border-color);
}

.chat-message.pinned {
    border-color: var(--text-secondary) !important;
    background: var(--hover-bg);
}

.ng-words-list {
    max-height: 120px;
    overflow-y: auto;
    min-height: 40px;
}

.ng-words-list .badge {
    margin: 2px 4px 2px 0;
    font-size: 11px;
    cursor: pointer;
}

.timeout-list {
    max-height: 100px;
    overflow-y: auto;
    min-height: 30px;
    font-size: 13px;
}

.card-header {
    font-weight: 600;
}

.chat-messages-scroll::-webkit-scrollbar {
    width: 6px;
}

.chat-messages-scroll::-webkit-scrollbar-track {
    background: var(--light-bg);
    border-radius: 3px;
}

.chat-messages-scroll::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 3px;
}

.chat-messages-scroll::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}

.ng-words-list::-webkit-scrollbar,
.timeout-list::-webkit-scrollbar {
    width: 4px;
}

.ng-words-list::-webkit-scrollbar-track,
.timeout-list::-webkit-scrollbar-track {
    background: transparent;
}

.ng-words-list::-webkit-scrollbar-thumb,
.timeout-list::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 2px;
}

@media (max-width: 768px) {
    .streaming-dashboard .row {
        flex-direction: column;
    }
    
    .streaming-dashboard .col-lg-7,
    .streaming-dashboard .col-lg-5 {
        width: 100%;
        margin-bottom: 16px;
    }
    
    .settings-section {
        margin-top: 16px;
    }
    
    .tab-nav {
        flex-wrap: wrap;
    }
    
    .tab-nav-item {
        flex: 1;
        text-align: center;
        font-size: 13px;
        padding: 12px 8px;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 8px;
    }
    
    .action-buttons .btn {
        width: 100%;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .quality-selector .quality-option {
        padding: 8px;
    }
    
    .quality-desc {
        font-size: 12px !important;
    }
}

@media (max-width: 576px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .tab-nav-item {
        font-size: 12px;
        padding: 10px 6px;
    }
    
    .settings-header {
        padding: 16px 20px 12px;
    }
    
    .settings-body {
        padding: 20px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="streaming-dashboard">
    <div class="container-fluid">
        <div class="row">
            <!-- Left Column: Preview -->
            <div class="col-lg-7">
                <div class="preview-section">
                    <div class="stream-preview">
                        <div class="stream-status-indicator status-{{ stream.status }}">
                            {{ stream.get_status_display }}
                        </div>
                        <div class="preview-content">
                            <i class="bi bi-play-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <h5>é…ä¿¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5>
                            <p>é…ä¿¡ã‚½ãƒ•ãƒˆã«æ¥ç¶šã—ã¦ãƒ©ã‚¤ãƒ–é…ä¿¡ã‚’é–‹å§‹ã—ã¾ã™</p>
                        </div>
                    </div>
                    <div class="preview-info">
                        {% if stream.status == 'live' %}
                            <div class="viewer-count">
                                <div class="live-indicator"></div>
                                <span>{{ stream.viewer_count }} äººãŒè¦–è´ä¸­</span>
                            </div>
                        {% else %}
                            <div class="viewer-count">
                                <i class="bi bi-circle" style="color: var(--text-secondary);"></i>
                                <span>é…ä¿¡å¾…æ©Ÿä¸­</span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="stream-help-text">
                    <i class="bi bi-info-circle"></i>
                    <span>ãƒ©ã‚¤ãƒ–é…ä¿¡ã‚’å…¬é–‹ã™ã‚‹ã«ã¯ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° ã‚½ãƒ•ãƒˆã§ç”»é¢ã®é€ä¿¡ã‚’é–‹å§‹ã—ã¾ã™</span>
                </div>
            </div>

            <!-- Right Column: Settings -->
            <div class="col-lg-5">
                <div class="settings-section">
                    <div class="settings-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 style="margin: 0;">{{ stream.title }}</h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="toggleEditMode()">ç·¨é›†</button>
                        </div>
                        <div style="margin-top: 8px; color: var(--text-secondary); font-size: 14px;">
                            ã‚«ãƒ†ã‚´ãƒª: {{ stream.category.name|default:"æœªè¨­å®š" }}
                        </div>
                        <div style="margin-top: 4px; color: var(--text-secondary); font-size: 14px;">
                            ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼: 
                            <i class="bi bi-globe" style="margin-right: 4px;"></i>
                            {{ stream.get_privacy_display }}
                        </div>
                        <div style="margin-top: 8px; color: var(--text-secondary); font-size: 13px;">
                            é…ä¿¡ä¸­ã®ç¾åœ¨è¦–è´è€…æ•°: {{ stream.viewer_count }}
                        </div>
                        <div style="color: var(--text-secondary); font-size: 13px;">
                            é«˜è©•ä¾¡ã®æ•°: 0
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="settings-body">
                        <div class="action-buttons" style="margin-top: 0; padding-top: 0; border-top: none;">
                            {% if stream.status == 'created' %}
                                <form method="post" action="{% url 'streaming:start_stream' stream.stream_id %}" style="flex: 1;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-secondary w-100">
                                        <i class="bi bi-play-circle-fill me-2"></i>é…ä¿¡ã‚’é–‹å§‹
                                    </button>
                                </form>
                            {% elif stream.status == 'live' %}
                                <form method="post" action="{% url 'streaming:end_stream' stream.stream_id %}" style="flex: 1;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-secondary w-100">
                                        <i class="bi bi-stop-circle-fill me-2"></i>é…ä¿¡ã‚’çµ‚äº†
                                    </button>
                                </form>
                            {% endif %}
                            
                            {% if stream.status == 'live' %}
                                <a href="{% url 'streaming:watch' stream.stream_id %}" target="_blank" 
                                   class="btn btn-outline-secondary">
                                    <i class="bi bi-eye me-1"></i>è¦–è´
                                </a>
                            {% endif %}
                        </div>

                        <div class="action-buttons">
                            <a href="{% url 'streaming:my_streams' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>é…ä¿¡ä¸€è¦§ã«æˆ»ã‚‹
                            </a>
                            {% if stream.status == 'ended' %}
                                <button class="btn btn-outline-secondary" onclick="deleteStream()">
                                    <i class="bi bi-trash me-1"></i>å‰Šé™¤
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="dashboard-tabs">
            <div class="tab-nav">
                <button class="tab-nav-item active" data-tab="settings">ãƒ©ã‚¤ãƒ–é…ä¿¡ã®è¨­å®š</button>
                <button class="tab-nav-item" data-tab="obs-settings">OBSé€£æº</button>
                <button class="tab-nav-item" data-tab="analytics">ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</button>
                <button class="tab-nav-item" data-tab="chat-management">ãƒãƒ£ãƒƒãƒˆç®¡ç†</button>
                <button class="tab-nav-item" data-tab="stream-details">ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®è©³ç´°</button>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content active" id="settings">
                <div class="row">
                    <div class="col-lg-6">
                        <!-- ãƒ¡ã‚¤ãƒ³é…ä¿¡è¨­å®š -->
                        <h6 style="margin-bottom: 16px;">é…ä¿¡è¨­å®š</h6>
                        
                        <!-- ã‚¹ãƒˆãƒªãƒ¼ãƒ URL -->
                        <div class="stream-key-section">
                            <div class="form-group">
                                <label class="form-label">ã‚¹ãƒˆãƒªãƒ¼ãƒ URL</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" value="{{ stream.ingest_url }}" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ stream.ingest_url }}')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚­ãƒ¼ -->
                        <div class="stream-key-section">
                            <div class="form-group">
                                <label class="form-label">ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚­ãƒ¼</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="stream-key" 
                                           value="{{ stream.stream_key }}" readonly>
                                    <button class="btn btn-outline-secondary" type="button" id="toggle-key">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ stream.stream_key }}')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
                        <div class="backup-settings mt-4">
                            <button class="btn btn-link p-0 mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#backupSettings" aria-expanded="false">
                                <i class="bi bi-chevron-right me-1" id="backup-chevron"></i>
                                <span>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</span>
                            </button>
                            
                            <div class="collapse" id="backupSettings">
                                <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ URL -->
                                <div class="stream-key-section">
                                    <div class="form-group">
                                        <label class="form-label">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ URL</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" value="{{ stream.backup_ingest_url|default:'rtmp://backup.example.com/live' }}" readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ stream.backup_ingest_url|default:'' }}')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚­ãƒ¼ -->
                                <div class="stream-key-section">
                                    <div class="form-group">
                                        <label class="form-label">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚­ãƒ¼</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="backup-stream-key" 
                                                   value="{{ stream.backup_stream_key|default:'backup-key-placeholder' }}" readonly>
                                            <button class="btn btn-outline-secondary" type="button" id="toggle-backup-key">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ stream.backup_stream_key|default:'' }}')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <h6 style="margin-bottom: 16px;">ãã®ä»–ã®è¨­å®š</h6>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>DVR ã‚’æœ‰åŠ¹ã«ã™ã‚‹</h6>
                                <p>è¦–è´è€…ãŒé…ä¿¡ã‚’æœ€åˆã‹ã‚‰è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™</p>
                            </div>
                            <div class="toggle-switch {% if stream.is_recording %}active{% endif %}" data-setting="recording">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>360Â° å‹•ç”»</h6>
                                <p>360åº¦ã¾ãŸã¯180åº¦ã®å‹•ç”»ã‚’é…ä¿¡ã™ã‚‹å ´åˆã«æœ‰åŠ¹ã«ã—ã¾ã™</p>
                            </div>
                            <div class="toggle-switch" data-setting="360video">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>å­—å¹•</h6>
                                <p>è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸå­—å¹•ã‚’è¡¨ç¤ºã—ã¾ã™</p>
                            </div>
                            <div class="toggle-switch" data-setting="subtitles">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>ãƒãƒ£ãƒƒãƒˆã‚’æœ‰åŠ¹ã«ã™ã‚‹</h6>
                                <p>è¦–è´è€…ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒãƒ£ãƒƒãƒˆã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™</p>
                            </div>
                            <div class="toggle-switch {% if stream.enable_chat %}active{% endif %}" data-setting="chat" id="chat-toggle">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>ç™»éŒ²è€…ã®ã¿ãƒãƒ£ãƒƒãƒˆ</h6>
                                <p>ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²è€…ã®ã¿ãŒãƒãƒ£ãƒƒãƒˆã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™</p>
                            </div>
                            <div class="toggle-switch {% if stream.subscriber_only_chat %}active{% endif %}" data-setting="subscriber-chat">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>é…ä¿¡ãŒçµ‚äº†ã—ãŸã‚‰ãƒ©ã‚¤ãƒ–ã®ãƒªãƒ—ãƒ¬ã‚¤ã‚’é™å®šå…¬é–‹ã«ã™ã‚‹</h6>
                            </div>
                            <div class="toggle-switch" data-setting="auto-archive">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <h6 style="margin-bottom: 16px;">ãƒ©ã‚¤ãƒ–é…ä¿¡ã®é…å»¶</h6>
                        <div class="quality-selector">
                            <div class="quality-option selected">
                                <input type="radio" class="quality-radio" name="latency" value="normal" checked>
                                <div class="quality-info">
                                    <div class="quality-name">é€šå¸¸ã®é…å»¶</div>
                                    <div class="quality-desc">å“è³ªã‚’å„ªå…ˆã—ã€é…å»¶ã¯ç´„20ç§’ã§ã™</div>
                                </div>
                            </div>
                            <div class="quality-option">
                                <input type="radio" class="quality-radio" name="latency" value="low">
                                <div class="quality-info">
                                    <div class="quality-name">ä½é…å»¶</div>
                                    <div class="quality-desc">ãƒãƒ£ãƒƒãƒˆã¨ã®å¿œç­”æ€§ã‚’å‘ä¸Šã•ã›ã¾ã™ï¼ˆç´„2-5ç§’ï¼‰</div>
                                </div>
                            </div>
                            <div class="quality-option">
                                <input type="radio" class="quality-radio" name="latency" value="ultra-low">
                                <div class="quality-info">
                                    <div class="quality-name">è¶…ä½é…å»¶</div>
                                    <div class="quality-desc">æœ€çŸ­é…å»¶ï¼ˆç´„1ç§’æœªæº€ï¼‰ã€é™å®šçš„ãªé…ä¿¡å“è³ª</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OBS Settings Tab -->
            <div class="tab-content" id="obs-settings">
                <div class="row">
                    <div class="col-lg-8">
                        <h6 style="margin-bottom: 16px;">OBS ãƒãƒ£ãƒƒãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¨­å®š</h6>
                        <p class="text-muted mb-4">é…ä¿¡ã‚½ãƒ•ãƒˆï¼ˆOBS Studioç­‰ï¼‰ã§ãƒ‹ã‚³ãƒ‹ã‚³å‹•ç”»é¢¨ã®ãƒãƒ£ãƒƒãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚</p>
                        
                        <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤URLè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                        <div class="stream-key-section">
                            <!-- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰URL -->
                            <div class="form-group mb-3">
                                <label class="form-label">
                                    <i class="bi bi-person-fill text-primary"></i> é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤ºï¼‰
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="obs-overlay-url-normal" 
                                           value="{% if stream.obs_overlay_token %}{{ stream.get_obs_overlay_url }}?anonymous=false{% else %}URLã‚’ç”Ÿæˆã—ã¦ãã ã•ã„{% endif %}" 
                                           readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(document.getElementById('obs-overlay-url-normal').value)">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" onclick="testObsOverlay('normal')" {% if not stream.obs_overlay_token %}disabled{% endif %}>
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">ä¾‹: ã€Œviewer: ã“ã‚“ã«ã¡ã¯ï¼ã€</small>
                            </div>
                            
                            <!-- åŒ¿åãƒ¢ãƒ¼ãƒ‰URL -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="bi bi-incognito text-secondary"></i> åŒ¿åãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‹ã‚³ãƒ‹ã‚³é¢¨ï¼‰
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="obs-overlay-url-anonymous" 
                                           value="{% if stream.obs_overlay_token %}{{ stream.get_obs_overlay_url }}?anonymous=true{% else %}URLã‚’ç”Ÿæˆã—ã¦ãã ã•ã„{% endif %}" 
                                           readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(document.getElementById('obs-overlay-url-anonymous').value)">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" onclick="testObsOverlay('anonymous')" {% if not stream.obs_overlay_token %}disabled{% endif %}>
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">ä¾‹: ã€Œã“ã‚“ã«ã¡ã¯ï¼ã€ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åãªã—ï¼‰</small>
                            </div>
                            
                            <div class="d-flex gap-2 align-items-center mt-3">
                                {% if not stream.obs_overlay_token %}
                                <button class="btn btn-outline-secondary" onclick="generateObsToken()">
                                    URLç”Ÿæˆ
                                </button>
                                {% else %}
                                <div class="alert alert-success mb-0 flex-grow-1" style="font-size: 13px;">
                                    <i class="bi bi-check-circle"></i>
                                    URLãŒç”Ÿæˆæ¸ˆã¿ã§ã™ã€‚ä¸Šè¨˜ã®URLã‚’OBSã«è¨­å®šã—ã¦ãã ã•ã„
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- OBSè¨­å®šæ‰‹é † -->
                        <div class="mt-4">
                            <h6 style="margin-bottom: 16px;">OBS Studioè¨­å®šæ‰‹é †</h6>
                            <div class="card">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <strong>1. ãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ </strong>
                                        <p class="mb-1 text-muted">OBS â†’ ã‚½ãƒ¼ã‚¹ â†’ + â†’ ãƒ–ãƒ©ã‚¦ã‚¶</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>2. URLè¨­å®š</strong>
                                        <p class="mb-1 text-muted">ä¸Šè¨˜ã®ã€ŒOBSç”¨ ãƒãƒ£ãƒƒãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤URLã€ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦URLæ¬„ã«è²¼ã‚Šä»˜ã‘</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>3. ã‚µã‚¤ã‚ºè¨­å®š</strong>
                                        <p class="mb-1 text-muted">å¹…: 1920, é«˜ã•: 1080 ï¼ˆé…ä¿¡è§£åƒåº¦ã«åˆã‚ã›ã¦èª¿æ•´ï¼‰</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>4. ã‚¯ãƒ­ãƒã‚­ãƒ¼è¨­å®š</strong>
                                        <p class="mb-1 text-muted">ãƒ•ã‚£ãƒ«ã‚¿ â†’ + â†’ ã‚¯ãƒ­ãƒã‚­ãƒ¼ â†’ è‰²ã‚’é¸æŠ: ç·‘</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">

                        <div class="mt-4">
                            <h6 style="margin-bottom: 16px;">ãƒ¢ãƒ¼ãƒ‰é¸æŠã«ã¤ã„ã¦</h6>
                            <div class="row">
                                <div class="col-6">
                                    <div class="card">
                                        <div class="card-body text-center p-2">
                                            <i class="bi bi-person-fill text-primary"></i>
                                            <div class="fw-bold small">é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</div>
                                            <div style="font-size: 11px; color: var(--text-secondary);">
                                                viewer: ã“ã‚“ã«ã¡ã¯<br>
                                                streamer ğŸ˜Š
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card">
                                        <div class="card-body text-center p-2">
                                            <i class="bi bi-incognito text-secondary"></i>
                                            <div class="fw-bold small">åŒ¿åãƒ¢ãƒ¼ãƒ‰</div>
                                            <div style="font-size: 11px; color: var(--text-secondary);">
                                                ã“ã‚“ã«ã¡ã¯<br>
                                                ğŸ˜Š
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle"></i> é…ä¿¡ã‚¹ã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ã¦ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„
                            </small>
                        </div>

                        <div class="mt-4">
                            <h6 style="margin-bottom: 16px;">æ©Ÿèƒ½èª¬æ˜</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå³ã‹ã‚‰å·¦ã«æµã‚Œã‚‹
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³/ã‚¹ã‚¿ãƒ³ãƒ—ã‚‚è¡¨ç¤ºå¯¾å¿œ
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    é‡è¤‡å›é¿ã§èª­ã¿ã‚„ã™ã„é…ç½®
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    åŒ¿åãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼ˆãƒ‹ã‚³ãƒ‹ã‚³å‹•ç”»é¢¨ï¼‰
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    ã‚»ã‚­ãƒ¥ã‚¢ãªãƒˆãƒ¼ã‚¯ãƒ³ã§ä¿è­·
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-content" id="analytics">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">{{ stream.viewer_count }}</div>
                        <div class="stat-label">ç¾åœ¨ã®è¦–è´è€…</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ stream.peak_viewers }}</div>
                        <div class="stat-label">æœ€å¤§è¦–è´è€…</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ stream.total_views }}</div>
                        <div class="stat-label">ç·è¦–è´å›æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                    </div>
                </div>
                <p style="color: var(--text-secondary); text-align: center; margin-top: 40px;">
                    è©³ç´°ãªã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹æ©Ÿèƒ½ã¯å®Ÿè£…äºˆå®šã§ã™
                </p>
            </div>

            <!-- Chat Management Tab -->
            <div class="tab-content" id="chat-management">
                <!-- Top Control Bar -->
                <div class="chat-control-bar mb-3 p-3 bg-light rounded">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" id="refresh-chat">
                                    <i class="bi bi-arrow-clockwise"></i> æ›´æ–°
                                </button>
                                <div class="form-check form-switch ms-3">
                                    <input class="form-check-input" type="checkbox" id="auto-refresh-chat" checked>
                                    <label class="form-check-label" for="auto-refresh-chat">è‡ªå‹•æ›´æ–°</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- Quick Stats -->
                            <div class="d-flex justify-content-end gap-4 text-center">
                                <div>
                                    <div class="fs-5 fw-bold text-primary" id="total-messages">0</div>
                                    <small class="text-muted">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</small>
                                </div>
                                <div>
                                    <div class="fs-5 fw-bold text-success" id="active-users">0</div>
                                    <small class="text-muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼</small>
                                </div>
                                <div>
                                    <div class="fs-5 fw-bold text-danger" id="deleted-messages">0</div>
                                    <small class="text-muted">å‰Šé™¤</small>
                                </div>
                                <div>
                                    <div class="fs-5 fw-bold text-info" id="pinned-messages">0</div>
                                    <small class="text-muted">ãƒ”ãƒ³</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Chat Messages Section -->
                    <div class="col-lg-7">
                        <div class="settings-section">
                            <div class="settings-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-chat-dots me-2"></i>ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                                </h5>
                            </div>
                            <div class="settings-body p-0">
                                <!-- Chat messages container -->
                                <div id="chat-messages-container" class="chat-messages-scroll">
                                    <div class="text-center text-muted p-4">
                                        <i class="bi bi-chat-dots" style="font-size: 48px;"></i>
                                        <p class="mt-3">ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Moderation Panel -->
                    <div class="col-lg-5">
                        <!-- NGãƒ¯ãƒ¼ãƒ‰ç®¡ç† -->
                        <div class="card mb-3">
                            <div class="card-header bg-light border-bottom py-2">
                                <h6 class="mb-0 text-dark"><i class="bi bi-shield-slash me-2"></i>NGãƒ¯ãƒ¼ãƒ‰ç®¡ç†</h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control form-control-sm" id="banned-words-input" 
                                           placeholder="ã‚¹ãƒ‘ãƒ , è¿·æƒ‘è¡Œç‚º (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="addBannedWords()">
                                        <i class="bi bi-plus"></i> è¿½åŠ 
                                    </button>
                                </div>
                                <div id="current-banned-words" class="ng-words-list">
                                    <div class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</div>
                                </div>
                            </div>
                        </div>

                        <!-- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç®¡ç† -->
                        <div class="card mb-3">
                            <div class="card-header bg-light border-bottom py-2">
                                <h6 class="mb-0 text-dark"><i class="bi bi-clock me-2"></i>ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç®¡ç†</h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="mb-2">
                                    <textarea class="form-control form-control-sm" id="timeout-usernames" rows="2" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹: user1, user2, user3ï¼‰"></textarea>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <select class="form-select form-select-sm" id="timeout-duration">
                                            <option value="5">5åˆ†</option>
                                            <option value="30">30åˆ†</option>
                                            <option value="60">1æ™‚é–“</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="timeoutUsers()">
                                            <i class="bi bi-clock me-1"></i>ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå®Ÿè¡Œ
                                        </button>
                                    </div>
                                </div>
                                <div id="active-timeouts" class="timeout-list">
                                    <div class="text-muted small">ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“</div>
                                </div>
                            </div>
                        </div>

                        <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <div class="card">
                            <div class="card-header bg-light border-bottom py-2">
                                <h6 class="mb-0 text-dark"><i class="bi bi-gear me-2"></i>ç®¡ç†æ“ä½œ</h6>
                            </div>
                            <div class="card-body p-3">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="exportModerationLog()">
                                    <i class="bi bi-download me-1"></i>ãƒ­ã‚°å‡ºåŠ›
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stream Details Tab -->
            <div class="tab-content" id="stream-details">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">é…ä¿¡å“è³ª</label>
                            <div class="form-control" style="background: var(--light-bg);">
                                {{ stream.quality }} - {{ stream.bitrate }} kbps - {{ stream.framerate }} FPS
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ¥ç¶šçŠ¶æ…‹</label>
                            <div class="form-control" style="background: var(--light-bg);">
                                {% if stream.status == 'live' %}
                                    <span style="color: var(--text-secondary);">æ¥ç¶šä¸­</span>
                                {% else %}
                                    <span style="color: var(--text-secondary);">æœªæ¥ç¶š</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">ä½œæˆæ—¥æ™‚</label>
                            <div class="form-control" style="background: var(--light-bg);">
                                {{ stream.created_at|date:"Yå¹´næœˆjæ—¥ H:i" }}
                            </div>
                        </div>
                        {% if stream.started_at %}
                            <div class="form-group">
                                <label class="form-label">é–‹å§‹æ—¥æ™‚</label>
                                <div class="form-control" style="background: var(--light-bg);">
                                    {{ stream.started_at|date:"Yå¹´næœˆjæ—¥ H:i" }}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    const tabButtons = document.querySelectorAll('.tab-nav-item');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            
            // Update active button
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Update active content
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === targetTab) {
                    content.classList.add('active');
                }
            });
        });
    });
    
    // Toggle stream key visibility
    const toggleKeyBtn = document.getElementById('toggle-key');
    const streamKeyInput = document.getElementById('stream-key');
    
    if (toggleKeyBtn && streamKeyInput) {
        toggleKeyBtn.addEventListener('click', () => {
            if (streamKeyInput.type === 'password') {
                streamKeyInput.type = 'text';
                toggleKeyBtn.innerHTML = '<i class="bi bi-eye-slash"></i>';
            } else {
                streamKeyInput.type = 'password';
                toggleKeyBtn.innerHTML = '<i class="bi bi-eye"></i>';
            }
        });
    }
    
    // Toggle backup stream key visibility
    const toggleBackupKeyBtn = document.getElementById('toggle-backup-key');
    const backupStreamKeyInput = document.getElementById('backup-stream-key');
    
    if (toggleBackupKeyBtn && backupStreamKeyInput) {
        toggleBackupKeyBtn.addEventListener('click', () => {
            if (backupStreamKeyInput.type === 'password') {
                backupStreamKeyInput.type = 'text';
                toggleBackupKeyBtn.innerHTML = '<i class="bi bi-eye-slash"></i>';
            } else {
                backupStreamKeyInput.type = 'password';
                toggleBackupKeyBtn.innerHTML = '<i class="bi bi-eye"></i>';
            }
        });
    }
    
    // Backup settings collapse handler
    const backupSettings = document.getElementById('backupSettings');
    const backupChevron = document.getElementById('backup-chevron');
    
    if (backupSettings && backupChevron) {
        backupSettings.addEventListener('shown.bs.collapse', () => {
            backupChevron.classList.remove('bi-chevron-right');
            backupChevron.classList.add('bi-chevron-down');
        });
        
        backupSettings.addEventListener('hidden.bs.collapse', () => {
            backupChevron.classList.remove('bi-chevron-down');
            backupChevron.classList.add('bi-chevron-right');
        });
    }
    
    // Toggle switches
    const toggleSwitches = document.querySelectorAll('.toggle-switch');
    toggleSwitches.forEach(toggle => {
        toggle.addEventListener('click', () => {
            const setting = toggle.getAttribute('data-setting');
            
            // Handle special settings that need server updates
            if (setting === 'chat') {
                toggleChatSetting(toggle);
            } else {
                // Regular toggle for other settings
                toggle.classList.toggle('active');
            }
        });
    });
    
    // Quality option selection
    const qualityOptions = document.querySelectorAll('.quality-option');
    qualityOptions.forEach(option => {
        option.addEventListener('click', () => {
            qualityOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            const radio = option.querySelector('.quality-radio');
            if (radio) radio.checked = true;
        });
    });
    
    // Real-time updates for live streams
    {% if stream.status == 'live' %}
        setInterval(updateStreamStats, 30000); // Update every 30 seconds
    {% endif %}
});

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
            btn.innerHTML = originalHtml;
        }, 1500);
    });
}

function updateStreamStats() {
    fetch(`{% url "streaming:stream_status_api" stream.stream_id %}`)
        .then(response => response.json())
        .then(data => {
            if (data.viewer_count !== undefined) {
                const viewerElements = document.querySelectorAll('[id*="viewer"], .viewer-count span');
                viewerElements.forEach(el => {
                    if (el.textContent.includes('äººãŒè¦–è´ä¸­')) {
                        el.textContent = `${data.viewer_count} äººãŒè¦–è´ä¸­`;
                    }
                });
            }
        })
        .catch(error => console.log('Stats update failed:', error));
}

function toggleEditMode() {
    alert('ç·¨é›†æ©Ÿèƒ½ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚è¿‘æ—¥ä¸­ã«å®Ÿè£…äºˆå®šã§ã™ã€‚');
}

function toggleChatSetting(toggle) {
    const isCurrentlyActive = toggle.classList.contains('active');
    
    // Optimistic UI update
    toggle.classList.toggle('active');
    
    fetch(`/api/chat/api/toggle/{{ stream.stream_id }}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Chat setting updated:', data.chat_enabled);
            // UI is already updated optimistically
        } else {
            // Revert on failure
            if (isCurrentlyActive) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            alert('ãƒãƒ£ãƒƒãƒˆè¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
    })
    .catch(error => {
        console.error('Chat toggle error:', error);
        // Revert on error
        if (isCurrentlyActive) {
            toggle.classList.add('active');
        } else {
            toggle.classList.remove('active');
        }
        alert('ãƒãƒ£ãƒƒãƒˆè¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function deleteStream() {
    if (confirm('ã“ã®é…ä¿¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
        window.location.href = `{% url "streaming:delete_stream" stream.stream_id %}`;
    }
}

// OBS ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤é–¢é€£æ©Ÿèƒ½
function generateObsToken() {
    fetch(`{% url 'streaming:generate_obs_token' stream.stream_id %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ–°ã—ã„URLã‚’è¡¨ç¤º
            alert('OBSç”¨URLã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼');
            window.location.reload();
        } else {
            alert('URLç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
    })
    .catch(error => {
        console.error('OBS token generation error:', error);
        alert('URLç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function testObsOverlay(mode) {
    let obsUrl;
    if (mode === 'anonymous') {
        obsUrl = document.getElementById('obs-overlay-url-anonymous').value;
    } else {
        obsUrl = document.getElementById('obs-overlay-url-normal').value;
    }
    
    if (obsUrl && obsUrl !== 'URLã‚’ç”Ÿæˆã—ã¦ãã ã•ã„') {
        // ã™ã§ã«anonymousãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€debugãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        const separator = obsUrl.includes('?') ? '&' : '?';
        window.open(obsUrl + separator + 'debug=true', '_blank');
    } else {
        alert('ã¾ãšURLã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
    }
}

// Chat Management Functions
let chatRefreshInterval = null;
let chatMessages = [];
let uniqueUsers = new Set();

function loadChatMessages() {
    fetch(`/api/chat/history/{{ stream.stream_id }}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.messages) {
            chatMessages = data.messages;
            displayChatMessages();
            updateChatStatistics();
        }
    })
    .catch(error => {
        console.error('Error loading chat messages:', error);
    });
}

function displayChatMessages() {
    const container = document.getElementById('chat-messages-container');
    if (!container) return;
    
    if (chatMessages.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted p-4">
                <i class="bi bi-chat-dots" style="font-size: 36px;"></i>
                <p class="mt-2">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        `;
        updateChatStatistics();
        return;
    }
    
    container.innerHTML = '';
    uniqueUsers.clear();
    
    chatMessages.forEach(msg => {
        uniqueUsers.add(msg.username);
        const messageEl = document.createElement('div');
        messageEl.className = `chat-message${msg.is_pinned ? ' pinned' : ''}`;
        messageEl.dataset.messageId = msg.id;
        
        const isPinned = msg.is_pinned ? '<i class="bi bi-pin-angle-fill text-primary me-1"></i>' : '';
        
        messageEl.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center">
                        ${isPinned}
                        <strong class="me-2">${msg.username}</strong>
                        <small class="text-muted">${new Date(msg.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}</small>
                    </div>
                    <div class="mt-1">${msg.message}</div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="togglePin(${msg.id})">
                            <i class="bi bi-pin${msg.is_pinned ? '-fill' : ''} me-2"></i>${msg.is_pinned ? 'ãƒ”ãƒ³è§£é™¤' : 'ãƒ”ãƒ³ç•™ã‚'}
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteMessage(${msg.id})">
                            <i class="bi bi-trash me-2"></i>å‰Šé™¤
                        </a></li>
                    </ul>
                </div>
            </div>
        `;
        
        container.appendChild(messageEl);
    });
    
    // Update statistics
    updateChatStatistics();
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

function updateChatStatistics() {
    document.getElementById('total-messages').textContent = chatMessages.length;
    document.getElementById('active-users').textContent = uniqueUsers.size;
    
    const deletedCount = chatMessages.filter(msg => msg.is_deleted).length;
    document.getElementById('deleted-messages').textContent = deletedCount;
    
    const pinnedCount = chatMessages.filter(msg => msg.is_pinned).length;
    document.getElementById('pinned-messages').textContent = pinnedCount;
}

function togglePin(messageId) {
    fetch(`/api/chat/moderate/${messageId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'action=pin',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadChatMessages();
        } else {
            alert('æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
    })
    .catch(error => {
        console.error('Error toggling pin:', error);
    });
}

function deleteMessage(messageId) {
    if (!confirm('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    fetch(`/api/chat/moderate/${messageId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'action=delete',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadChatMessages();
        } else {
            alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
    })
    .catch(error => {
        console.error('Error deleting message:', error);
    });
}

// Chat management event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Load chat messages when chat tab is opened
    const chatTab = document.querySelector('[data-tab="chat-management"]');
    if (chatTab) {
        const originalClickHandler = chatTab.onclick;
        chatTab.onclick = function(e) {
            if (originalClickHandler) originalClickHandler.call(this, e);
            loadChatMessages();
            
            // Start auto-refresh if enabled
            const autoRefresh = document.getElementById('auto-refresh-chat');
            if (autoRefresh && autoRefresh.checked) {
                startChatAutoRefresh();
            }
        };
    }
    
    // Refresh button - now refreshes both chat messages and moderation data
    const refreshBtn = document.getElementById('refresh-chat');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            loadChatMessages();
            refreshModerationData();
        });
    }
    
    // Auto-refresh toggle
    const autoRefreshToggle = document.getElementById('auto-refresh-chat');
    if (autoRefreshToggle) {
        autoRefreshToggle.addEventListener('change', function() {
            if (this.checked) {
                startChatAutoRefresh();
            } else {
                stopChatAutoRefresh();
            }
        });
    }
    
});

function startChatAutoRefresh() {
    stopChatAutoRefresh();
    chatRefreshInterval = setInterval(loadChatMessages, 5000); // Refresh every 5 seconds
}

function stopChatAutoRefresh() {
    if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
    }
}

// Moderation Functions
function addBannedWords() {
    const wordsInput = document.getElementById('banned-words-input');
    const words = wordsInput.value.trim();
    
    if (!words) {
        alert('NGãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    fetch(`/api/chat/banned-words/{{ stream.stream_id }}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ words: words }),
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            wordsInput.value = '';
            loadBannedWords();
            alert(data.message);
        } else {
            alert('NGãƒ¯ãƒ¼ãƒ‰è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
    })
    .catch(error => {
        console.error('Error adding banned words:', error);
        alert('NGãƒ¯ãƒ¼ãƒ‰è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function loadBannedWords() {
    fetch(`/api/chat/banned-words/{{ stream.stream_id }}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('current-banned-words');
        
        if (data.banned_words && data.banned_words.length > 0) {
            container.innerHTML = '';
            data.banned_words.forEach(word => {
                const wordEl = document.createElement('span');
                wordEl.className = 'badge bg-secondary me-1 mb-1 d-inline-flex align-items-center';
                wordEl.style.fontSize = '10px';
                wordEl.innerHTML = `
                    ${word.word}
                    <button class="btn btn-sm ms-1 p-0 border-0 bg-transparent" onclick="removeBannedWord(${word.id})" title="å‰Šé™¤">
                        <i class="bi bi-x text-white" style="font-size: 12px;"></i>
                    </button>
                `;
                container.appendChild(wordEl);
            });
        } else {
            container.innerHTML = '<div class="text-muted small">NGãƒ¯ãƒ¼ãƒ‰ãªã—</div>';
        }
    })
    .catch(error => {
        console.error('Error loading banned words:', error);
        document.getElementById('current-banned-words').innerHTML = 
            '<div class="text-danger small">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
    });
}

function removeBannedWord(wordId) {
    if (!confirm('ã“ã®NGãƒ¯ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    fetch(`/api/chat/banned-words/remove/${wordId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadBannedWords();
            alert(data.message);
        } else {
            alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
    })
    .catch(error => {
        console.error('Error removing banned word:', error);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function timeoutUsers() {
    const usernames = document.getElementById('timeout-usernames').value.trim();
    const duration = parseInt(document.getElementById('timeout-duration').value);
    
    if (!usernames) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’åˆ†å‰²
    const usernameList = usernames.split(',').map(name => name.trim()).filter(name => name);
    
    if (usernameList.length === 0) {
        alert('æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    // è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ä¸¦è¡Œå®Ÿè¡Œ
    const timeoutPromises = usernameList.map(username => {
        return fetch(`/api/chat/timeout/{{ stream.stream_id }}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                username: username, 
                duration: duration,
                reason: 'Manual timeout by streamer'
            }),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => ({ username, success: data.success, message: data.message, error: data.error }));
    });
    
    Promise.all(timeoutPromises)
    .then(results => {
        const successful = results.filter(r => r.success);
        const failed = results.filter(r => !r.success);
        
        let message = '';
        if (successful.length > 0) {
            message += `${successful.length}äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ\n`;
        }
        if (failed.length > 0) {
            message += `${failed.length}äººã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:\n`;
            failed.forEach(f => {
                message += `- ${f.username}: ${f.error}\n`;
            });
        }
        
        document.getElementById('timeout-usernames').value = '';
        loadActiveTimeouts();
        alert(message);
    })
    .catch(error => {
        console.error('Error timing out users:', error);
        alert('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function loadActiveTimeouts() {
    fetch(`/api/chat/timeouts/{{ stream.stream_id }}/`, {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('active-timeouts');
        
        if (data.timeouts && data.timeouts.length > 0) {
            let html = '';
            data.timeouts.forEach(timeout => {
                const expiresAt = new Date(timeout.expires_at);
                const now = new Date();
                const remainingMinutes = Math.ceil((expiresAt - now) / (1000 * 60));
                
                html += `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <div>
                            <strong>${timeout.username}</strong>
                            <div class="text-muted small">${timeout.reason}</div>
                            <div class="text-muted small">æ®‹ã‚Š ${remainingMinutes} åˆ†</div>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="removeTimeout(${timeout.id})">
                            è§£é™¤
                        </button>
                    </div>
                `;
            });
            container.innerHTML = html;
        } else {
            container.innerHTML = '<div class="text-muted small">ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“</div>';
        }
    })
    .catch(error => {
        console.error('Error loading timeouts:', error);
        const container = document.getElementById('active-timeouts');
        container.innerHTML = '<div class="text-danger small">ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    });
}

function removeTimeout(timeoutId) {
    if (!confirm('ã“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    fetch(`/api/chat/timeout/remove/${timeoutId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadActiveTimeouts();
            alert(data.message);
        } else {
            alert('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
    })
    .catch(error => {
        console.error('Error removing timeout:', error);
        alert('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function refreshModerationData() {
    loadBannedWords();
    loadActiveTimeouts();
}

// Load moderation data when chat management tab is opened
document.addEventListener('DOMContentLoaded', function() {
    const chatTab = document.querySelector('[data-tab="chat-management"]');
    if (chatTab) {
        const originalClickHandler = chatTab.onclick;
        chatTab.onclick = function(e) {
            if (originalClickHandler) originalClickHandler.call(this, e);
            
            // Load moderation data
            setTimeout(() => {
                refreshModerationData();
            }, 100);
        };
    }
});

// ç®¡ç†æ“ä½œæ©Ÿèƒ½
function exportModerationLog() {
    // ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    const streamId = '{{ stream.stream_id }}';
    const currentDate = new Date().toISOString().split('T')[0];
    
    // ç¾åœ¨ã®NGãƒ¯ãƒ¼ãƒ‰ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    Promise.all([
        fetch(`/api/chat/banned-words/${streamId}/`, { credentials: 'same-origin' }),
        fetch(`/api/chat/timeouts/${streamId}/`, { credentials: 'same-origin' })
    ])
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(([bannedWordsData, timeoutsData]) => {
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼
        csvContent += "ç¨®åˆ¥,å†…å®¹,ä½œæˆæ—¥æ™‚,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹\n";
        
        // NGãƒ¯ãƒ¼ãƒ‰
        if (bannedWordsData.banned_words) {
            bannedWordsData.banned_words.forEach(word => {
                csvContent += `NGãƒ¯ãƒ¼ãƒ‰,"${word.word}","${word.created_at}",ã‚¢ã‚¯ãƒ†ã‚£ãƒ–\n`;
            });
        }
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
        if (timeoutsData.timeouts) {
            timeoutsData.timeouts.forEach(timeout => {
                const expiresAt = new Date(timeout.expires_at).toLocaleString('ja-JP');
                csvContent += `ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ,"${timeout.username} (${timeout.duration}åˆ†)","${timeout.created_at}","${expiresAt}ã¾ã§"\n`;
            });
        }
        
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `moderation_log_${currentDate}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert('ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
    })
    .catch(error => {
        console.error('Error exporting log:', error);
        alert('ãƒ­ã‚°ã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

</script>
{% endblock %}