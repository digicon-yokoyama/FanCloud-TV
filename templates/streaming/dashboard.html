{% extends 'base/base.html' %}
{% load static %}

{% block title %}é…ä¿¡ç®¡ç† - {{ stream.title }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
:root {
    --brand-red: #ff0000;
    --light-bg: #f9f9f9;
    --card-bg: #ffffff;
    --border-color: #e0e0e0;
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --hover-bg: #f5f5f5;
}

.streaming-dashboard {
    background: var(--light-bg);
    min-height: calc(100vh - 76px);
    color: var(--text-primary);
}

.preview-section {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 0;
    position: relative;
    overflow: hidden;
}

.stream-preview {
    width: 100%;
    aspect-ratio: 16/9;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.preview-content {
    text-align: center;
    color: white;
}


.stream-status-indicator {
    position: absolute;
    top: 12px;
    left: 12px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    z-index: 5;
    color: white;
}

.status-created { background: #2196f3; }
.status-live { background: var(--brand-red); }
.status-ended { background: #666; }
.status-error { background: #ff9800; }

.preview-info {
    padding: 16px;
    border-top: 1px solid var(--border-color);
    background: var(--card-bg);
    position: relative;
    z-index: 10;
}

.stream-help-text {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    margin-top: 16px;
    display: flex;
    align-items: center;
}

.stream-help-text i {
    margin-right: 8px;
    color: var(--text-secondary);
}

.settings-section {
    background: var(--card-bg);
    border-radius: 12px;
    height: fit-content;
}

.settings-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border-color);
}

.settings-body {
    padding: 24px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: var(--text-primary);
    font-size: 14px;
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    background: var(--light-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: #2196f3;
    background: var(--light-bg);
    color: var(--text-primary);
}

.form-control::placeholder {
    color: var(--text-secondary);
}

.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23aaa' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
}

.viewer-count {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--text-secondary);
}

.live-indicator {
    width: 8px;
    height: 8px;
    background: var(--brand-red);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.dashboard-tabs {
    background: var(--card-bg);
    border-radius: 12px;
    margin-top: 24px;
    overflow: hidden;
}

.tab-nav {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
}

.tab-nav-item {
    padding: 16px 24px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    position: relative;
}

.tab-nav-item:hover {
    background: var(--hover-bg);
    color: var(--text-primary);
}

.tab-nav-item.active {
    color: var(--text-primary);
    border-bottom-color: #2196f3;
}

.tab-content {
    display: none;
    padding: 24px;
}

.tab-content.active {
    display: block;
}

.stream-key-section {
    background: #f8f9fa;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 20px;
}

.input-group {
    display: flex;
    border-radius: 8px;
    overflow: hidden;
}

.input-group .form-control {
    border-radius: 0;
    border-right: none;
    flex: 1;
}

.input-group .btn {
    border-radius: 0;
    border: 1px solid var(--border-color);
    border-left: none;
}

.btn-brand {
    background: #2196f3;
    border-color: #2196f3;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 500;
    transition: background-color 0.2s;
}

.btn-brand:hover {
    background: #1976d2;
    color: white;
}

.btn-brand-outline {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-brand-outline:hover {
    background: var(--hover-bg);
    color: var(--text-primary);
    border-color: var(--text-secondary);
}

.btn-brand-red {
    background: var(--brand-red);
    border-color: var(--brand-red);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 16px;
    transition: background-color 0.2s;
}

.btn-brand-red:hover {
    background: #cc0000;
    color: white;
}

.quality-selector {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.quality-option {
    display: flex;
    align-items: center;
    padding: 12px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.quality-option:hover {
    border-color: #2196f3;
    background: rgba(33, 150, 243, 0.1);
}

.quality-option.selected {
    border-color: #2196f3;
    background: rgba(33, 150, 243, 0.15);
}

.quality-radio {
    margin-right: 12px;
    accent-color: #2196f3;
}

.quality-info {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.quality-name {
    font-weight: 500;
    color: var(--text-primary);
}

.quality-desc {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 2px;
}

.action-buttons {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: flex-start;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border-color);
}

.toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
    background: #ccc;
    border-radius: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.toggle-switch.active {
    background: #2196f3;
}

.toggle-switch::before {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: transform 0.2s;
}

.toggle-switch.active::before {
    transform: translateX(20px);
}

.setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 0;
    border-bottom: 1px solid var(--border-color);
}

.setting-row:last-child {
    border-bottom: none;
}

.setting-info h6 {
    margin: 0;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
}

.setting-info p {
    margin: 4px 0 0;
    font-size: 13px;
    color: var(--text-secondary);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.stat-label {
    font-size: 13px;
    color: var(--text-secondary);
}

@media (max-width: 768px) {
    .streaming-dashboard .row {
        flex-direction: column;
    }
    
    .streaming-dashboard .col-lg-7,
    .streaming-dashboard .col-lg-5 {
        width: 100%;
        margin-bottom: 16px;
    }
    
    .settings-section {
        margin-top: 16px;
    }
    
    .tab-nav {
        flex-wrap: wrap;
    }
    
    .tab-nav-item {
        flex: 1;
        text-align: center;
        font-size: 13px;
        padding: 12px 8px;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 8px;
    }
    
    .action-buttons .btn {
        width: 100%;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .quality-selector .quality-option {
        padding: 8px;
    }
    
    .quality-desc {
        font-size: 12px !important;
    }
}

@media (max-width: 576px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .tab-nav-item {
        font-size: 12px;
        padding: 10px 6px;
    }
    
    .settings-header {
        padding: 16px 20px 12px;
    }
    
    .settings-body {
        padding: 20px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="streaming-dashboard">
    <div class="container-fluid">
        <div class="row">
            <!-- Left Column: Preview -->
            <div class="col-lg-7">
                <div class="preview-section">
                    <div class="stream-preview">
                        <div class="stream-status-indicator status-{{ stream.status }}">
                            {{ stream.get_status_display }}
                        </div>
                        <div class="preview-content">
                            <i class="bi bi-play-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <h5>é…ä¿¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5>
                            <p>é…ä¿¡ã‚½ãƒ•ãƒˆã«æ¥ç¶šã—ã¦ãƒ©ã‚¤ãƒ–é…ä¿¡ã‚’é–‹å§‹ã—ã¾ã™</p>
                        </div>
                    </div>
                    <div class="preview-info">
                        {% if stream.status == 'live' %}
                            <div class="viewer-count">
                                <div class="live-indicator"></div>
                                <span>{{ stream.viewer_count }} äººãŒè¦–è´ä¸­</span>
                            </div>
                        {% else %}
                            <div class="viewer-count">
                                <i class="bi bi-circle" style="color: #666;"></i>
                                <span>é…ä¿¡å¾…æ©Ÿä¸­</span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="stream-help-text">
                    <i class="bi bi-info-circle"></i>
                    <span>ãƒ©ã‚¤ãƒ–é…ä¿¡ã‚’å…¬é–‹ã™ã‚‹ã«ã¯ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° ã‚½ãƒ•ãƒˆã§ç”»é¢ã®é€ä¿¡ã‚’é–‹å§‹ã—ã¾ã™</span>
                </div>
            </div>

            <!-- Right Column: Settings -->
            <div class="col-lg-5">
                <div class="settings-section">
                    <div class="settings-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 style="margin: 0;">{{ stream.title }}</h5>
                            <button class="btn btn-brand-outline btn-sm" onclick="toggleEditMode()">ç·¨é›†</button>
                        </div>
                        <div style="margin-top: 8px; color: var(--text-secondary); font-size: 14px;">
                            ã‚«ãƒ†ã‚´ãƒª: {{ stream.category.name|default:"æœªè¨­å®š" }}
                        </div>
                        <div style="margin-top: 4px; color: var(--text-secondary); font-size: 14px;">
                            ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼: 
                            <i class="bi bi-globe" style="margin-right: 4px;"></i>
                            {{ stream.get_privacy_display }}
                        </div>
                        <div style="margin-top: 8px; color: var(--text-secondary); font-size: 13px;">
                            é…ä¿¡ä¸­ã®ç¾åœ¨è¦–è´è€…æ•°: {{ stream.viewer_count }}
                        </div>
                        <div style="color: var(--text-secondary); font-size: 13px;">
                            é«˜è©•ä¾¡ã®æ•°: 0
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="settings-body">
                        <div class="action-buttons" style="margin-top: 0; padding-top: 0; border-top: none;">
                            {% if stream.status == 'created' %}
                                <form method="post" action="{% url 'streaming:start_stream' stream.stream_id %}" style="flex: 1;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-brand-red w-100">
                                        <i class="bi bi-play-circle-fill me-2"></i>é…ä¿¡ã‚’é–‹å§‹
                                    </button>
                                </form>
                            {% elif stream.status == 'live' %}
                                <form method="post" action="{% url 'streaming:end_stream' stream.stream_id %}" style="flex: 1;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-brand-red w-100">
                                        <i class="bi bi-stop-circle-fill me-2"></i>é…ä¿¡ã‚’çµ‚äº†
                                    </button>
                                </form>
                            {% endif %}
                            
                            {% if stream.status == 'live' %}
                                <a href="{% url 'streaming:watch' stream.stream_id %}" target="_blank" 
                                   class="btn btn-brand-outline">
                                    <i class="bi bi-eye me-1"></i>è¦–è´
                                </a>
                            {% endif %}
                        </div>

                        <div class="action-buttons">
                            <a href="{% url 'streaming:my_streams' %}" class="btn btn-brand-outline">
                                <i class="bi bi-arrow-left me-2"></i>é…ä¿¡ä¸€è¦§ã«æˆ»ã‚‹
                            </a>
                            {% if stream.status == 'ended' %}
                                <button class="btn btn-brand-outline" onclick="deleteStream()">
                                    <i class="bi bi-trash me-1"></i>å‰Šé™¤
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="dashboard-tabs">
            <div class="tab-nav">
                <button class="tab-nav-item active" data-tab="settings">ãƒ©ã‚¤ãƒ–é…ä¿¡ã®è¨­å®š</button>
                <button class="tab-nav-item" data-tab="obs-settings">OBSé€£æº</button>
                <button class="tab-nav-item" data-tab="analytics">ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹</button>
                <button class="tab-nav-item" data-tab="stream-details">ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®è©³ç´°</button>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content active" id="settings">
                <div class="row">
                    <div class="col-lg-6">
                        <!-- ãƒ¡ã‚¤ãƒ³é…ä¿¡è¨­å®š -->
                        <h6 style="margin-bottom: 16px;">é…ä¿¡è¨­å®š</h6>
                        
                        <!-- ã‚¹ãƒˆãƒªãƒ¼ãƒ URL -->
                        <div class="stream-key-section">
                            <div class="form-group">
                                <label class="form-label">ã‚¹ãƒˆãƒªãƒ¼ãƒ URL</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" value="{{ stream.ingest_url }}" readonly>
                                    <button class="btn btn-brand-outline" type="button" onclick="copyToClipboard('{{ stream.ingest_url }}')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚­ãƒ¼ -->
                        <div class="stream-key-section">
                            <div class="form-group">
                                <label class="form-label">ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚­ãƒ¼</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="stream-key" 
                                           value="{{ stream.stream_key }}" readonly>
                                    <button class="btn btn-brand-outline" type="button" id="toggle-key">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-brand-outline" type="button" onclick="copyToClipboard('{{ stream.stream_key }}')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
                        <div class="backup-settings mt-4">
                            <button class="btn btn-link p-0 mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#backupSettings" aria-expanded="false">
                                <i class="bi bi-chevron-right me-1" id="backup-chevron"></i>
                                <span>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</span>
                            </button>
                            
                            <div class="collapse" id="backupSettings">
                                <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ URL -->
                                <div class="stream-key-section">
                                    <div class="form-group">
                                        <label class="form-label">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ URL</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" value="{{ stream.backup_ingest_url|default:'rtmp://backup.example.com/live' }}" readonly>
                                            <button class="btn btn-brand-outline" type="button" onclick="copyToClipboard('{{ stream.backup_ingest_url|default:'' }}')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚­ãƒ¼ -->
                                <div class="stream-key-section">
                                    <div class="form-group">
                                        <label class="form-label">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚­ãƒ¼</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="backup-stream-key" 
                                                   value="{{ stream.backup_stream_key|default:'backup-key-placeholder' }}" readonly>
                                            <button class="btn btn-brand-outline" type="button" id="toggle-backup-key">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-brand-outline" type="button" onclick="copyToClipboard('{{ stream.backup_stream_key|default:'' }}')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <h6 style="margin-bottom: 16px;">ãã®ä»–ã®è¨­å®š</h6>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>DVR ã‚’æœ‰åŠ¹ã«ã™ã‚‹</h6>
                                <p>è¦–è´è€…ãŒé…ä¿¡ã‚’æœ€åˆã‹ã‚‰è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™</p>
                            </div>
                            <div class="toggle-switch {% if stream.is_recording %}active{% endif %}" data-setting="recording">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>360Â° å‹•ç”»</h6>
                                <p>360åº¦ã¾ãŸã¯180åº¦ã®å‹•ç”»ã‚’é…ä¿¡ã™ã‚‹å ´åˆã«æœ‰åŠ¹ã«ã—ã¾ã™</p>
                            </div>
                            <div class="toggle-switch" data-setting="360video">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>å­—å¹•</h6>
                                <p>è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸå­—å¹•ã‚’è¡¨ç¤ºã—ã¾ã™</p>
                            </div>
                            <div class="toggle-switch" data-setting="subtitles">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>ãƒãƒ£ãƒƒãƒˆã‚’æœ‰åŠ¹ã«ã™ã‚‹</h6>
                                <p>è¦–è´è€…ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒãƒ£ãƒƒãƒˆã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™</p>
                            </div>
                            <div class="toggle-switch {% if stream.enable_chat %}active{% endif %}" data-setting="chat" id="chat-toggle">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>ç™»éŒ²è€…ã®ã¿ãƒãƒ£ãƒƒãƒˆ</h6>
                                <p>ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²è€…ã®ã¿ãŒãƒãƒ£ãƒƒãƒˆã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™</p>
                            </div>
                            <div class="toggle-switch {% if stream.subscriber_only_chat %}active{% endif %}" data-setting="subscriber-chat">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>é…ä¿¡ãŒçµ‚äº†ã—ãŸã‚‰ãƒ©ã‚¤ãƒ–ã®ãƒªãƒ—ãƒ¬ã‚¤ã‚’é™å®šå…¬é–‹ã«ã™ã‚‹</h6>
                            </div>
                            <div class="toggle-switch" data-setting="auto-archive">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <h6 style="margin-bottom: 16px;">ãƒ©ã‚¤ãƒ–é…ä¿¡ã®é…å»¶</h6>
                        <div class="quality-selector">
                            <div class="quality-option selected">
                                <input type="radio" class="quality-radio" name="latency" value="normal" checked>
                                <div class="quality-info">
                                    <div class="quality-name">é€šå¸¸ã®é…å»¶</div>
                                    <div class="quality-desc">å“è³ªã‚’å„ªå…ˆã—ã€é…å»¶ã¯ç´„20ç§’ã§ã™</div>
                                </div>
                            </div>
                            <div class="quality-option">
                                <input type="radio" class="quality-radio" name="latency" value="low">
                                <div class="quality-info">
                                    <div class="quality-name">ä½é…å»¶</div>
                                    <div class="quality-desc">ãƒãƒ£ãƒƒãƒˆã¨ã®å¿œç­”æ€§ã‚’å‘ä¸Šã•ã›ã¾ã™ï¼ˆç´„2-5ç§’ï¼‰</div>
                                </div>
                            </div>
                            <div class="quality-option">
                                <input type="radio" class="quality-radio" name="latency" value="ultra-low">
                                <div class="quality-info">
                                    <div class="quality-name">è¶…ä½é…å»¶</div>
                                    <div class="quality-desc">æœ€çŸ­é…å»¶ï¼ˆç´„1ç§’æœªæº€ï¼‰ã€é™å®šçš„ãªé…ä¿¡å“è³ª</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OBS Settings Tab -->
            <div class="tab-content" id="obs-settings">
                <div class="row">
                    <div class="col-lg-8">
                        <h6 style="margin-bottom: 16px;">OBS ãƒãƒ£ãƒƒãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¨­å®š</h6>
                        <p class="text-muted mb-4">é…ä¿¡ã‚½ãƒ•ãƒˆï¼ˆOBS Studioç­‰ï¼‰ã§ãƒ‹ã‚³ãƒ‹ã‚³å‹•ç”»é¢¨ã®ãƒãƒ£ãƒƒãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚</p>
                        
                        <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤URLè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                        <div class="stream-key-section">
                            <!-- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰URL -->
                            <div class="form-group mb-3">
                                <label class="form-label">
                                    <i class="bi bi-person-fill text-primary"></i> é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤ºï¼‰
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="obs-overlay-url-normal" 
                                           value="{% if stream.obs_overlay_token %}{{ stream.get_obs_overlay_url }}?anonymous=false{% else %}URLã‚’ç”Ÿæˆã—ã¦ãã ã•ã„{% endif %}" 
                                           readonly>
                                    <button class="btn btn-brand-outline" type="button" onclick="copyToClipboard(document.getElementById('obs-overlay-url-normal').value)">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                    <button class="btn btn-brand-outline" type="button" onclick="testObsOverlay('normal')" 
                                            {% if not stream.obs_overlay_token %}disabled{% endif %}>
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">ä¾‹: ã€Œviewer: ã“ã‚“ã«ã¡ã¯ï¼ã€</small>
                            </div>
                            
                            <!-- åŒ¿åãƒ¢ãƒ¼ãƒ‰URL -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="bi bi-incognito text-secondary"></i> åŒ¿åãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‹ã‚³ãƒ‹ã‚³é¢¨ï¼‰
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="obs-overlay-url-anonymous" 
                                           value="{% if stream.obs_overlay_token %}{{ stream.get_obs_overlay_url }}?anonymous=true{% else %}URLã‚’ç”Ÿæˆã—ã¦ãã ã•ã„{% endif %}" 
                                           readonly>
                                    <button class="btn btn-brand-outline" type="button" onclick="copyToClipboard(document.getElementById('obs-overlay-url-anonymous').value)">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                    <button class="btn btn-brand-outline" type="button" onclick="testObsOverlay('anonymous')" 
                                            {% if not stream.obs_overlay_token %}disabled{% endif %}>
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">ä¾‹: ã€Œã“ã‚“ã«ã¡ã¯ï¼ã€ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åãªã—ï¼‰</small>
                            </div>
                            
                            <div class="d-flex gap-2 align-items-center mt-3">
                                {% if not stream.obs_overlay_token %}
                                <button class="btn btn-brand" onclick="generateObsToken()">
                                    ğŸ”— URLç”Ÿæˆ
                                </button>
                                {% else %}
                                <div class="alert alert-success mb-0 flex-grow-1" style="font-size: 13px;">
                                    <i class="bi bi-check-circle"></i>
                                    URLãŒç”Ÿæˆæ¸ˆã¿ã§ã™ã€‚ä¸Šè¨˜ã®URLã‚’OBSã«è¨­å®šã—ã¦ãã ã•ã„
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- OBSè¨­å®šæ‰‹é † -->
                        <div class="mt-4">
                            <h6 style="margin-bottom: 16px;">OBS Studioè¨­å®šæ‰‹é †</h6>
                            <div class="card">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <strong>1. ãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ </strong>
                                        <p class="mb-1 text-muted">OBS â†’ ã‚½ãƒ¼ã‚¹ â†’ + â†’ ãƒ–ãƒ©ã‚¦ã‚¶</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>2. URLè¨­å®š</strong>
                                        <p class="mb-1 text-muted">ä¸Šè¨˜ã®ã€ŒOBSç”¨ ãƒãƒ£ãƒƒãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤URLã€ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦URLæ¬„ã«è²¼ã‚Šä»˜ã‘</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>3. ã‚µã‚¤ã‚ºè¨­å®š</strong>
                                        <p class="mb-1 text-muted">å¹…: 1920, é«˜ã•: 1080 ï¼ˆé…ä¿¡è§£åƒåº¦ã«åˆã‚ã›ã¦èª¿æ•´ï¼‰</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>4. ã‚¯ãƒ­ãƒã‚­ãƒ¼è¨­å®š</strong>
                                        <p class="mb-1 text-muted">ãƒ•ã‚£ãƒ«ã‚¿ â†’ + â†’ ã‚¯ãƒ­ãƒã‚­ãƒ¼ â†’ è‰²ã‚’é¸æŠ: ç·‘ (#00FF00)</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">

                        <div class="mt-4">
                            <h6 style="margin-bottom: 16px;">ãƒ¢ãƒ¼ãƒ‰é¸æŠã«ã¤ã„ã¦</h6>
                            <div class="row">
                                <div class="col-6">
                                    <div class="card">
                                        <div class="card-body text-center p-2">
                                            <i class="bi bi-person-fill text-primary"></i>
                                            <div class="fw-bold small">é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</div>
                                            <div style="font-size: 11px; color: #666;">
                                                viewer: ã“ã‚“ã«ã¡ã¯<br>
                                                streamer ğŸ˜Š
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card">
                                        <div class="card-body text-center p-2">
                                            <i class="bi bi-incognito text-secondary"></i>
                                            <div class="fw-bold small">åŒ¿åãƒ¢ãƒ¼ãƒ‰</div>
                                            <div style="font-size: 11px; color: #666;">
                                                ã“ã‚“ã«ã¡ã¯<br>
                                                ğŸ˜Š
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle"></i> é…ä¿¡ã‚¹ã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ã¦ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„
                            </small>
                        </div>

                        <div class="mt-4">
                            <h6 style="margin-bottom: 16px;">æ©Ÿèƒ½èª¬æ˜</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå³ã‹ã‚‰å·¦ã«æµã‚Œã‚‹
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³/ã‚¹ã‚¿ãƒ³ãƒ—ã‚‚è¡¨ç¤ºå¯¾å¿œ
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    é‡è¤‡å›é¿ã§èª­ã¿ã‚„ã™ã„é…ç½®
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    åŒ¿åãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼ˆãƒ‹ã‚³ãƒ‹ã‚³å‹•ç”»é¢¨ï¼‰
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    ã‚»ã‚­ãƒ¥ã‚¢ãªãƒˆãƒ¼ã‚¯ãƒ³ã§ä¿è­·
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-content" id="analytics">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">{{ stream.viewer_count }}</div>
                        <div class="stat-label">ç¾åœ¨ã®è¦–è´è€…</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ stream.peak_viewers }}</div>
                        <div class="stat-label">æœ€å¤§è¦–è´è€…</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ stream.total_views }}</div>
                        <div class="stat-label">ç·è¦–è´å›æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                    </div>
                </div>
                <p style="color: var(--text-secondary); text-align: center; margin-top: 40px;">
                    è©³ç´°ãªã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹æ©Ÿèƒ½ã¯å®Ÿè£…äºˆå®šã§ã™
                </p>
            </div>

            <!-- Stream Details Tab -->
            <div class="tab-content" id="stream-details">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">é…ä¿¡å“è³ª</label>
                            <div class="form-control" style="background: var(--light-bg);">
                                {{ stream.quality }} - {{ stream.bitrate }} kbps - {{ stream.framerate }} FPS
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ¥ç¶šçŠ¶æ…‹</label>
                            <div class="form-control" style="background: var(--light-bg);">
                                {% if stream.status == 'live' %}
                                    <span style="color: #4caf50;">æ¥ç¶šä¸­</span>
                                {% else %}
                                    <span style="color: #666;">æœªæ¥ç¶š</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">ä½œæˆæ—¥æ™‚</label>
                            <div class="form-control" style="background: var(--light-bg);">
                                {{ stream.created_at|date:"Yå¹´næœˆjæ—¥ H:i" }}
                            </div>
                        </div>
                        {% if stream.started_at %}
                            <div class="form-group">
                                <label class="form-label">é–‹å§‹æ—¥æ™‚</label>
                                <div class="form-control" style="background: var(--light-bg);">
                                    {{ stream.started_at|date:"Yå¹´næœˆjæ—¥ H:i" }}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    const tabButtons = document.querySelectorAll('.tab-nav-item');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            
            // Update active button
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Update active content
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === targetTab) {
                    content.classList.add('active');
                }
            });
        });
    });
    
    // Toggle stream key visibility
    const toggleKeyBtn = document.getElementById('toggle-key');
    const streamKeyInput = document.getElementById('stream-key');
    
    if (toggleKeyBtn && streamKeyInput) {
        toggleKeyBtn.addEventListener('click', () => {
            if (streamKeyInput.type === 'password') {
                streamKeyInput.type = 'text';
                toggleKeyBtn.innerHTML = '<i class="bi bi-eye-slash"></i>';
            } else {
                streamKeyInput.type = 'password';
                toggleKeyBtn.innerHTML = '<i class="bi bi-eye"></i>';
            }
        });
    }
    
    // Toggle backup stream key visibility
    const toggleBackupKeyBtn = document.getElementById('toggle-backup-key');
    const backupStreamKeyInput = document.getElementById('backup-stream-key');
    
    if (toggleBackupKeyBtn && backupStreamKeyInput) {
        toggleBackupKeyBtn.addEventListener('click', () => {
            if (backupStreamKeyInput.type === 'password') {
                backupStreamKeyInput.type = 'text';
                toggleBackupKeyBtn.innerHTML = '<i class="bi bi-eye-slash"></i>';
            } else {
                backupStreamKeyInput.type = 'password';
                toggleBackupKeyBtn.innerHTML = '<i class="bi bi-eye"></i>';
            }
        });
    }
    
    // Backup settings collapse handler
    const backupSettings = document.getElementById('backupSettings');
    const backupChevron = document.getElementById('backup-chevron');
    
    if (backupSettings && backupChevron) {
        backupSettings.addEventListener('shown.bs.collapse', () => {
            backupChevron.classList.remove('bi-chevron-right');
            backupChevron.classList.add('bi-chevron-down');
        });
        
        backupSettings.addEventListener('hidden.bs.collapse', () => {
            backupChevron.classList.remove('bi-chevron-down');
            backupChevron.classList.add('bi-chevron-right');
        });
    }
    
    // Toggle switches
    const toggleSwitches = document.querySelectorAll('.toggle-switch');
    toggleSwitches.forEach(toggle => {
        toggle.addEventListener('click', () => {
            const setting = toggle.getAttribute('data-setting');
            
            // Handle special settings that need server updates
            if (setting === 'chat') {
                toggleChatSetting(toggle);
            } else {
                // Regular toggle for other settings
                toggle.classList.toggle('active');
            }
        });
    });
    
    // Quality option selection
    const qualityOptions = document.querySelectorAll('.quality-option');
    qualityOptions.forEach(option => {
        option.addEventListener('click', () => {
            qualityOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            const radio = option.querySelector('.quality-radio');
            if (radio) radio.checked = true;
        });
    });
    
    // Real-time updates for live streams
    {% if stream.status == 'live' %}
        setInterval(updateStreamStats, 30000); // Update every 30 seconds
    {% endif %}
});

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
            btn.innerHTML = originalHtml;
        }, 1500);
    });
}

function updateStreamStats() {
    fetch(`{% url "streaming:stream_status_api" stream.stream_id %}`)
        .then(response => response.json())
        .then(data => {
            if (data.viewer_count !== undefined) {
                const viewerElements = document.querySelectorAll('[id*="viewer"], .viewer-count span');
                viewerElements.forEach(el => {
                    if (el.textContent.includes('äººãŒè¦–è´ä¸­')) {
                        el.textContent = `${data.viewer_count} äººãŒè¦–è´ä¸­`;
                    }
                });
            }
        })
        .catch(error => console.log('Stats update failed:', error));
}

function toggleEditMode() {
    alert('ç·¨é›†æ©Ÿèƒ½ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚è¿‘æ—¥ä¸­ã«å®Ÿè£…äºˆå®šã§ã™ã€‚');
}

function toggleChatSetting(toggle) {
    const isCurrentlyActive = toggle.classList.contains('active');
    
    // Optimistic UI update
    toggle.classList.toggle('active');
    
    fetch(`/api/chat/api/toggle/{{ stream.stream_id }}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Chat setting updated:', data.chat_enabled);
            // UI is already updated optimistically
        } else {
            // Revert on failure
            if (isCurrentlyActive) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            alert('ãƒãƒ£ãƒƒãƒˆè¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
    })
    .catch(error => {
        console.error('Chat toggle error:', error);
        // Revert on error
        if (isCurrentlyActive) {
            toggle.classList.add('active');
        } else {
            toggle.classList.remove('active');
        }
        alert('ãƒãƒ£ãƒƒãƒˆè¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function deleteStream() {
    if (confirm('ã“ã®é…ä¿¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
        window.location.href = `{% url "streaming:delete_stream" stream.stream_id %}`;
    }
}

// OBS ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤é–¢é€£æ©Ÿèƒ½
function generateObsToken() {
    fetch(`{% url 'streaming:generate_obs_token' stream.stream_id %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ–°ã—ã„URLã‚’è¡¨ç¤º
            alert('OBSç”¨URLã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼');
            window.location.reload();
        } else {
            alert('URLç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
    })
    .catch(error => {
        console.error('OBS token generation error:', error);
        alert('URLç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

function testObsOverlay(mode) {
    let obsUrl;
    if (mode === 'anonymous') {
        obsUrl = document.getElementById('obs-overlay-url-anonymous').value;
    } else {
        obsUrl = document.getElementById('obs-overlay-url-normal').value;
    }
    
    if (obsUrl && obsUrl !== 'URLã‚’ç”Ÿæˆã—ã¦ãã ã•ã„') {
        // ã™ã§ã«anonymousãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€debugãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        const separator = obsUrl.includes('?') ? '&' : '?';
        window.open(obsUrl + separator + 'debug=true', '_blank');
    } else {
        alert('ã¾ãšURLã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
    }
}
</script>
{% endblock %}