{% extends 'base/base.html' %}
{% load static %}

{% block title %}配信管理 - {{ stream.title }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
:root {
    --light-bg: #f8f9fa;
    --card-bg: #ffffff;
    --border-color: #e0e0e0;
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --hover-bg: #f5f5f5;
}

.streaming-dashboard {
    background: var(--light-bg);
    min-height: calc(100vh - 76px);
    color: var(--text-primary);
}

.preview-section {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 0;
    position: relative;
    overflow: hidden;
}

.stream-preview {
    width: 100%;
    aspect-ratio: 16/9;
    background: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.preview-content {
    text-align: center;
    color: white;
}


.stream-status-indicator {
    position: absolute;
    top: 12px;
    left: 12px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    z-index: 5;
    color: white;
}

.status-created { background: #6c757d; }
.status-live { background: #6c757d; }
.status-ended { background: #6c757d; }
.status-error { background: #6c757d; }

.preview-info {
    padding: 16px;
    border-top: 1px solid var(--border-color);
    background: var(--card-bg);
    position: relative;
    z-index: 10;
}

.stream-help-text {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    margin-top: 16px;
    display: flex;
    align-items: center;
}

.stream-help-text i {
    margin-right: 8px;
    color: var(--text-secondary);
}

.settings-section {
    background: var(--card-bg);
    border-radius: 12px;
    height: fit-content;
}

.settings-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border-color);
}

.settings-body {
    padding: 24px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: var(--text-primary);
    font-size: 14px;
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    background: var(--light-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: var(--text-secondary);
    background: var(--light-bg);
    color: var(--text-primary);
}

.form-control::placeholder {
    color: var(--text-secondary);
}

.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23aaa' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
}

.viewer-count {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--text-secondary);
}

.live-indicator {
    width: 8px;
    height: 8px;
    background: var(--brand-red);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.dashboard-tabs {
    background: var(--card-bg);
    border-radius: 12px;
    margin-top: 24px;
    overflow: hidden;
}

.tab-nav {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    background: var(--card-bg);
}

.tab-nav-item {
    padding: 16px 24px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    position: relative;
}

.tab-nav-item:hover {
    background: var(--hover-bg);
    color: var(--text-primary);
}

.tab-nav-item.active {
    color: var(--text-primary);
    border-bottom-color: var(--text-secondary);
}

.tab-content {
    display: none;
    padding: 24px;
}

.tab-content.active {
    display: block;
}

.stream-key-section {
    background: #f8f9fa;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 20px;
}

.input-group {
    display: flex;
    border-radius: 8px;
    overflow: hidden;
}

.input-group .form-control {
    border-radius: 0;
    border-right: none;
    flex: 1;
}

.input-group .btn {
    border-radius: 0;
    border: 1px solid var(--border-color);
    border-left: none;
}




.quality-selector {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.quality-option {
    display: flex;
    align-items: center;
    padding: 12px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.quality-option:hover {
    border-color: var(--text-secondary);
    background: var(--hover-bg);
}

.quality-option.selected {
    border-color: var(--text-primary);
    background: var(--hover-bg);
}

.quality-radio {
    margin-right: 12px;
    accent-color: var(--text-secondary);
}

.quality-info {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.quality-name {
    font-weight: 500;
    color: var(--text-primary);
}

.quality-desc {
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 2px;
}

.action-buttons {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: flex-start;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--border-color);
}

.toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
    background: #ccc;
    border-radius: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.toggle-switch.active {
    background: var(--text-secondary);
}

.toggle-switch::before {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: transform 0.2s;
}

.toggle-switch.active::before {
    transform: translateX(20px);
}

.setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 0;
    border-bottom: 1px solid var(--border-color);
}

.setting-row:last-child {
    border-bottom: none;
}

.setting-info h6 {
    margin: 0;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
}

.setting-info p {
    margin: 4px 0 0;
    font-size: 13px;
    color: var(--text-secondary);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.stat-label {
    font-size: 13px;
    color: var(--text-secondary);
}

/* Chat Management Styles */
.chat-control-bar {
    border: 1px solid var(--border-color);
}

.chat-messages-scroll {
    height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    background: var(--card-bg);
}

.chat-message {
    background: var(--card-bg);
    transition: background 0.2s;
    padding: 8px 12px;
    margin-bottom: 8px;
    border-radius: 6px;
    border: 1px solid transparent;
}

.chat-message:hover {
    background: var(--hover-bg);
    border-color: var(--border-color);
}

.chat-message.pinned {
    border-color: var(--text-secondary) !important;
    background: var(--hover-bg);
}

.ng-words-list {
    max-height: 120px;
    overflow-y: auto;
    min-height: 40px;
}

.ng-words-list .badge {
    margin: 2px 4px 2px 0;
    font-size: 11px;
    cursor: pointer;
}

.timeout-list {
    max-height: 100px;
    overflow-y: auto;
    min-height: 30px;
    font-size: 13px;
}

.card-header {
    font-weight: 600;
}

.chat-messages-scroll::-webkit-scrollbar {
    width: 6px;
}

.chat-messages-scroll::-webkit-scrollbar-track {
    background: var(--light-bg);
    border-radius: 3px;
}

.chat-messages-scroll::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 3px;
}

.chat-messages-scroll::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}

.ng-words-list::-webkit-scrollbar,
.timeout-list::-webkit-scrollbar {
    width: 4px;
}

.ng-words-list::-webkit-scrollbar-track,
.timeout-list::-webkit-scrollbar-track {
    background: transparent;
}

.ng-words-list::-webkit-scrollbar-thumb,
.timeout-list::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 2px;
}

@media (max-width: 768px) {
    .streaming-dashboard .row {
        flex-direction: column;
    }
    
    .streaming-dashboard .col-lg-7,
    .streaming-dashboard .col-lg-5 {
        width: 100%;
        margin-bottom: 16px;
    }
    
    .settings-section {
        margin-top: 16px;
    }
    
    .tab-nav {
        flex-wrap: wrap;
    }
    
    .tab-nav-item {
        flex: 1;
        text-align: center;
        font-size: 13px;
        padding: 12px 8px;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 8px;
    }
    
    .action-buttons .btn {
        width: 100%;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .quality-selector .quality-option {
        padding: 8px;
    }
    
    .quality-desc {
        font-size: 12px !important;
    }
}

@media (max-width: 576px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .tab-nav-item {
        font-size: 12px;
        padding: 10px 6px;
    }
    
    .settings-header {
        padding: 16px 20px 12px;
    }
    
    .settings-body {
        padding: 20px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="streaming-dashboard">
    <div class="container-fluid">
        <div class="row">
            <!-- Left Column: Preview -->
            <div class="col-lg-7">
                <div class="preview-section">
                    <div class="stream-preview">
                        <div class="stream-status-indicator status-{{ stream.status }}">
                            {{ stream.get_status_display }}
                        </div>
                        <div class="preview-content">
                            <i class="bi bi-play-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <h5>配信プレビュー</h5>
                            <p>配信ソフトに接続してライブ配信を開始します</p>
                        </div>
                    </div>
                    <div class="preview-info">
                        {% if stream.status == 'live' %}
                            <div class="viewer-count">
                                <div class="live-indicator"></div>
                                <span>{{ stream.viewer_count }} 人が視聴中</span>
                            </div>
                        {% else %}
                            <div class="viewer-count">
                                <i class="bi bi-circle" style="color: var(--text-secondary);"></i>
                                <span>配信待機中</span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="stream-help-text">
                    <i class="bi bi-info-circle"></i>
                    <span>ライブ配信を公開するには、ストリーミング ソフトで画面の送信を開始します</span>
                </div>
            </div>

            <!-- Right Column: Settings -->
            <div class="col-lg-5">
                <div class="settings-section">
                    <div class="settings-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 style="margin: 0;">{{ stream.title }}</h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="toggleEditMode()">編集</button>
                        </div>
                        <div style="margin-top: 8px; color: var(--text-secondary); font-size: 14px;">
                            カテゴリ: {{ stream.category.name|default:"未設定" }}
                        </div>
                        <div style="margin-top: 4px; color: var(--text-secondary); font-size: 14px;">
                            プライバシー: 
                            <i class="bi bi-globe" style="margin-right: 4px;"></i>
                            {{ stream.get_privacy_display }}
                        </div>
                        <div style="margin-top: 8px; color: var(--text-secondary); font-size: 13px;">
                            配信中の現在視聴者数: {{ stream.viewer_count }}
                        </div>
                        <div style="color: var(--text-secondary); font-size: 13px;">
                            高評価の数: 0
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="settings-body">
                        <div class="action-buttons" style="margin-top: 0; padding-top: 0; border-top: none;">
                            {% if stream.status == 'created' %}
                                <form method="post" action="{% url 'streaming:start_stream' stream.stream_id %}" style="flex: 1;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-secondary w-100">
                                        <i class="bi bi-play-circle-fill me-2"></i>配信を開始
                                    </button>
                                </form>
                            {% elif stream.status == 'live' %}
                                <form method="post" action="{% url 'streaming:end_stream' stream.stream_id %}" style="flex: 1;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-secondary w-100">
                                        <i class="bi bi-stop-circle-fill me-2"></i>配信を終了
                                    </button>
                                </form>
                            {% endif %}
                            
                            {% if stream.status == 'live' %}
                                <a href="{% url 'streaming:watch' stream.stream_id %}" target="_blank" 
                                   class="btn btn-outline-secondary">
                                    <i class="bi bi-eye me-1"></i>視聴
                                </a>
                            {% endif %}
                        </div>

                        <div class="action-buttons">
                            <a href="{% url 'streaming:my_streams' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>配信一覧に戻る
                            </a>
                            {% if stream.status == 'ended' %}
                                <button class="btn btn-outline-secondary" onclick="deleteStream()">
                                    <i class="bi bi-trash me-1"></i>削除
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="dashboard-tabs">
            <div class="tab-nav">
                <button class="tab-nav-item active" data-tab="settings">ライブ配信の設定</button>
                <button class="tab-nav-item" data-tab="obs-settings">OBS連携</button>
                <button class="tab-nav-item" data-tab="analytics">アナリティクス</button>
                <button class="tab-nav-item" data-tab="chat-management">チャット管理</button>
                <button class="tab-nav-item" data-tab="stream-details">ストリームの詳細</button>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content active" id="settings">
                <div class="row">
                    <div class="col-lg-6">
                        <!-- メイン配信設定 -->
                        <h6 style="margin-bottom: 16px;">配信設定</h6>
                        
                        <!-- ストリームURL -->
                        <div class="stream-key-section">
                            <div class="form-group">
                                <label class="form-label">ストリームURL</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" value="{{ stream.ingest_url }}" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ stream.ingest_url }}')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ストリームキー -->
                        <div class="stream-key-section">
                            <div class="form-group">
                                <label class="form-label">ストリームキー</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="stream-key" 
                                           value="{{ stream.stream_key }}" readonly>
                                    <button class="btn btn-outline-secondary" type="button" id="toggle-key">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ stream.stream_key }}')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- オプション設定（折りたたみ） -->
                        <div class="backup-settings mt-4">
                            <button class="btn btn-link p-0 mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#backupSettings" aria-expanded="false">
                                <i class="bi bi-chevron-right me-1" id="backup-chevron"></i>
                                <span>バックアップ設定（オプション）</span>
                            </button>
                            
                            <div class="collapse" id="backupSettings">
                                <!-- バックアップストリームURL -->
                                <div class="stream-key-section">
                                    <div class="form-group">
                                        <label class="form-label">バックアップストリームURL</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" value="{{ stream.backup_ingest_url|default:'rtmp://backup.example.com/live' }}" readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ stream.backup_ingest_url|default:'' }}')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- バックアップストリームキー -->
                                <div class="stream-key-section">
                                    <div class="form-group">
                                        <label class="form-label">バックアップストリームキー</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="backup-stream-key" 
                                                   value="{{ stream.backup_stream_key|default:'backup-key-placeholder' }}" readonly>
                                            <button class="btn btn-outline-secondary" type="button" id="toggle-backup-key">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ stream.backup_stream_key|default:'' }}')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <h6 style="margin-bottom: 16px;">その他の設定</h6>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>DVR を有効にする</h6>
                                <p>視聴者が配信を最初から見ることができるようになります</p>
                            </div>
                            <div class="toggle-switch {% if stream.is_recording %}active{% endif %}" data-setting="recording">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>360° 動画</h6>
                                <p>360度または180度の動画を配信する場合に有効にします</p>
                            </div>
                            <div class="toggle-switch" data-setting="360video">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>字幕</h6>
                                <p>自動生成された字幕を表示します</p>
                            </div>
                            <div class="toggle-switch" data-setting="subtitles">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>チャットを有効にする</h6>
                                <p>視聴者がリアルタイムでチャットできるようにします</p>
                            </div>
                            <div class="toggle-switch {% if stream.enable_chat %}active{% endif %}" data-setting="chat" id="chat-toggle">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>登録者のみチャット</h6>
                                <p>チャンネル登録者のみがチャットできるようにします</p>
                            </div>
                            <div class="toggle-switch {% if stream.subscriber_only_chat %}active{% endif %}" data-setting="subscriber-chat">
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h6>配信が終了したらライブのリプレイを限定公開にする</h6>
                            </div>
                            <div class="toggle-switch" data-setting="auto-archive">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <h6 style="margin-bottom: 16px;">ライブ配信の遅延</h6>
                        <div class="quality-selector">
                            <div class="quality-option selected">
                                <input type="radio" class="quality-radio" name="latency" value="normal" checked>
                                <div class="quality-info">
                                    <div class="quality-name">通常の遅延</div>
                                    <div class="quality-desc">品質を優先し、遅延は約20秒です</div>
                                </div>
                            </div>
                            <div class="quality-option">
                                <input type="radio" class="quality-radio" name="latency" value="low">
                                <div class="quality-info">
                                    <div class="quality-name">低遅延</div>
                                    <div class="quality-desc">チャットとの応答性を向上させます（約2-5秒）</div>
                                </div>
                            </div>
                            <div class="quality-option">
                                <input type="radio" class="quality-radio" name="latency" value="ultra-low">
                                <div class="quality-info">
                                    <div class="quality-name">超低遅延</div>
                                    <div class="quality-desc">最短遅延（約1秒未満）、限定的な配信品質</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OBS Settings Tab -->
            <div class="tab-content" id="obs-settings">
                <div class="row">
                    <div class="col-lg-8">
                        <h6 style="margin-bottom: 16px;">OBS チャットオーバーレイ設定</h6>
                        <p class="text-muted mb-4">配信ソフト（OBS Studio等）でニコニコ動画風のチャットオーバーレイを表示できます。</p>
                        
                        <!-- オーバーレイURL表示エリア -->
                        <div class="stream-key-section">
                            <!-- 通常モードURL -->
                            <div class="form-group mb-3">
                                <label class="form-label">
                                    <i class="bi bi-person-fill text-primary"></i> 通常モード（ユーザー名表示）
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="obs-overlay-url-normal" 
                                           value="{% if stream.obs_overlay_token %}{{ stream.get_obs_overlay_url }}?anonymous=false{% else %}URLを生成してください{% endif %}" 
                                           readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(document.getElementById('obs-overlay-url-normal').value)">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" onclick="testObsOverlay('normal')" {% if not stream.obs_overlay_token %}disabled{% endif %}>
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">例: 「viewer: こんにちは！」</small>
                            </div>
                            
                            <!-- 匿名モードURL -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="bi bi-incognito text-secondary"></i> 匿名モード（ニコニコ風）
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="obs-overlay-url-anonymous" 
                                           value="{% if stream.obs_overlay_token %}{{ stream.get_obs_overlay_url }}?anonymous=true{% else %}URLを生成してください{% endif %}" 
                                           readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(document.getElementById('obs-overlay-url-anonymous').value)">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" onclick="testObsOverlay('anonymous')" {% if not stream.obs_overlay_token %}disabled{% endif %}>
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">例: 「こんにちは！」（ユーザー名なし）</small>
                            </div>
                            
                            <div class="d-flex gap-2 align-items-center mt-3">
                                {% if not stream.obs_overlay_token %}
                                <button class="btn btn-outline-secondary" onclick="generateObsToken()">
                                    URL生成
                                </button>
                                {% else %}
                                <div class="alert alert-success mb-0 flex-grow-1" style="font-size: 13px;">
                                    <i class="bi bi-check-circle"></i>
                                    URLが生成済みです。上記のURLをOBSに設定してください
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- OBS設定手順 -->
                        <div class="mt-4">
                            <h6 style="margin-bottom: 16px;">OBS Studio設定手順</h6>
                            <div class="card">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <strong>1. ブラウザソースを追加</strong>
                                        <p class="mb-1 text-muted">OBS → ソース → + → ブラウザ</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>2. URL設定</strong>
                                        <p class="mb-1 text-muted">上記の「OBS用 チャットオーバーレイURL」をコピーしてURL欄に貼り付け</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>3. サイズ設定</strong>
                                        <p class="mb-1 text-muted">幅: 1920, 高さ: 1080 （配信解像度に合わせて調整）</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>4. クロマキー設定</strong>
                                        <p class="mb-1 text-muted">フィルタ → + → クロマキー → 色を選択: 緑</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">

                        <div class="mt-4">
                            <h6 style="margin-bottom: 16px;">モード選択について</h6>
                            <div class="row">
                                <div class="col-6">
                                    <div class="card">
                                        <div class="card-body text-center p-2">
                                            <i class="bi bi-person-fill text-primary"></i>
                                            <div class="fw-bold small">通常モード</div>
                                            <div style="font-size: 11px; color: var(--text-secondary);">
                                                viewer: こんにちは<br>
                                                streamer 😊
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card">
                                        <div class="card-body text-center p-2">
                                            <i class="bi bi-incognito text-secondary"></i>
                                            <div class="fw-bold small">匿名モード</div>
                                            <div style="font-size: 11px; color: var(--text-secondary);">
                                                こんにちは<br>
                                                😊
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle"></i> 配信スタイルに合わせてモードを選択してください
                            </small>
                        </div>

                        <div class="mt-4">
                            <h6 style="margin-bottom: 16px;">機能説明</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    チャットメッセージが右から左に流れる
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    リアクション/スタンプも表示対応
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    重複回避で読みやすい配置
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    匿名モード対応（ニコニコ動画風）
                                </li>
                                <li class="mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    セキュアなトークンで保護
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-content" id="analytics">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">{{ stream.viewer_count }}</div>
                        <div class="stat-label">現在の視聴者</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ stream.peak_viewers }}</div>
                        <div class="stat-label">最大視聴者</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ stream.total_views }}</div>
                        <div class="stat-label">総視聴回数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">チャットメッセージ</div>
                    </div>
                </div>
                <p style="color: var(--text-secondary); text-align: center; margin-top: 40px;">
                    詳細なアナリティクス機能は実装予定です
                </p>
            </div>

            <!-- Chat Management Tab -->
            <div class="tab-content" id="chat-management">
                <!-- Top Control Bar -->
                <div class="chat-control-bar mb-3 p-3 bg-light rounded">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" id="refresh-chat">
                                    <i class="bi bi-arrow-clockwise"></i> 更新
                                </button>
                                <div class="form-check form-switch ms-3">
                                    <input class="form-check-input" type="checkbox" id="auto-refresh-chat" checked>
                                    <label class="form-check-label" for="auto-refresh-chat">自動更新</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- Quick Stats -->
                            <div class="d-flex justify-content-end gap-4 text-center">
                                <div>
                                    <div class="fs-5 fw-bold text-primary" id="total-messages">0</div>
                                    <small class="text-muted">メッセージ</small>
                                </div>
                                <div>
                                    <div class="fs-5 fw-bold text-success" id="active-users">0</div>
                                    <small class="text-muted">ユーザー</small>
                                </div>
                                <div>
                                    <div class="fs-5 fw-bold text-danger" id="deleted-messages">0</div>
                                    <small class="text-muted">削除</small>
                                </div>
                                <div>
                                    <div class="fs-5 fw-bold text-info" id="pinned-messages">0</div>
                                    <small class="text-muted">ピン</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Chat Messages Section -->
                    <div class="col-lg-7">
                        <div class="settings-section">
                            <div class="settings-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-chat-dots me-2"></i>チャットメッセージ
                                </h5>
                            </div>
                            <div class="settings-body p-0">
                                <!-- Chat messages container -->
                                <div id="chat-messages-container" class="chat-messages-scroll">
                                    <div class="text-center text-muted p-4">
                                        <i class="bi bi-chat-dots" style="font-size: 48px;"></i>
                                        <p class="mt-3">チャットメッセージを読み込み中...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Moderation Panel -->
                    <div class="col-lg-5">
                        <!-- NGワード管理 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light border-bottom py-2">
                                <h6 class="mb-0 text-dark"><i class="bi bi-shield-slash me-2"></i>NGワード管理</h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control form-control-sm" id="banned-words-input" 
                                           placeholder="スパム, 迷惑行為 (カンマ区切り)">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="addBannedWords()">
                                        <i class="bi bi-plus"></i> 追加
                                    </button>
                                </div>
                                <div id="current-banned-words" class="ng-words-list">
                                    <div class="text-muted small">読み込み中...</div>
                                </div>
                            </div>
                        </div>

                        <!-- タイムアウト管理 -->
                        <div class="card mb-3">
                            <div class="card-header bg-light border-bottom py-2">
                                <h6 class="mb-0 text-dark"><i class="bi bi-clock me-2"></i>タイムアウト管理</h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="mb-2">
                                    <textarea class="form-control form-control-sm" id="timeout-usernames" rows="2" placeholder="ユーザー名をカンマ区切りで入力（例: user1, user2, user3）"></textarea>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <select class="form-select form-select-sm" id="timeout-duration">
                                            <option value="5">5分</option>
                                            <option value="30">30分</option>
                                            <option value="60">1時間</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="timeoutUsers()">
                                            <i class="bi bi-clock me-1"></i>タイムアウト実行
                                        </button>
                                    </div>
                                </div>
                                <div id="active-timeouts" class="timeout-list">
                                    <div class="text-muted small">タイムアウト中のユーザーはいません</div>
                                </div>
                            </div>
                        </div>

                        <!-- クイックアクション -->
                        <div class="card">
                            <div class="card-header bg-light border-bottom py-2">
                                <h6 class="mb-0 text-dark"><i class="bi bi-gear me-2"></i>管理操作</h6>
                            </div>
                            <div class="card-body p-3">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="exportModerationLog()">
                                    <i class="bi bi-download me-1"></i>ログ出力
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stream Details Tab -->
            <div class="tab-content" id="stream-details">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">配信品質</label>
                            <div class="form-control" style="background: var(--light-bg);">
                                {{ stream.quality }} - {{ stream.bitrate }} kbps - {{ stream.framerate }} FPS
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">接続状態</label>
                            <div class="form-control" style="background: var(--light-bg);">
                                {% if stream.status == 'live' %}
                                    <span style="color: var(--text-secondary);">接続中</span>
                                {% else %}
                                    <span style="color: var(--text-secondary);">未接続</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">作成日時</label>
                            <div class="form-control" style="background: var(--light-bg);">
                                {{ stream.created_at|date:"Y年n月j日 H:i" }}
                            </div>
                        </div>
                        {% if stream.started_at %}
                            <div class="form-group">
                                <label class="form-label">開始日時</label>
                                <div class="form-control" style="background: var(--light-bg);">
                                    {{ stream.started_at|date:"Y年n月j日 H:i" }}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    const tabButtons = document.querySelectorAll('.tab-nav-item');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            
            // Update active button
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Update active content
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === targetTab) {
                    content.classList.add('active');
                }
            });
        });
    });
    
    // Toggle stream key visibility
    const toggleKeyBtn = document.getElementById('toggle-key');
    const streamKeyInput = document.getElementById('stream-key');
    
    if (toggleKeyBtn && streamKeyInput) {
        toggleKeyBtn.addEventListener('click', () => {
            if (streamKeyInput.type === 'password') {
                streamKeyInput.type = 'text';
                toggleKeyBtn.innerHTML = '<i class="bi bi-eye-slash"></i>';
            } else {
                streamKeyInput.type = 'password';
                toggleKeyBtn.innerHTML = '<i class="bi bi-eye"></i>';
            }
        });
    }
    
    // Toggle backup stream key visibility
    const toggleBackupKeyBtn = document.getElementById('toggle-backup-key');
    const backupStreamKeyInput = document.getElementById('backup-stream-key');
    
    if (toggleBackupKeyBtn && backupStreamKeyInput) {
        toggleBackupKeyBtn.addEventListener('click', () => {
            if (backupStreamKeyInput.type === 'password') {
                backupStreamKeyInput.type = 'text';
                toggleBackupKeyBtn.innerHTML = '<i class="bi bi-eye-slash"></i>';
            } else {
                backupStreamKeyInput.type = 'password';
                toggleBackupKeyBtn.innerHTML = '<i class="bi bi-eye"></i>';
            }
        });
    }
    
    // Backup settings collapse handler
    const backupSettings = document.getElementById('backupSettings');
    const backupChevron = document.getElementById('backup-chevron');
    
    if (backupSettings && backupChevron) {
        backupSettings.addEventListener('shown.bs.collapse', () => {
            backupChevron.classList.remove('bi-chevron-right');
            backupChevron.classList.add('bi-chevron-down');
        });
        
        backupSettings.addEventListener('hidden.bs.collapse', () => {
            backupChevron.classList.remove('bi-chevron-down');
            backupChevron.classList.add('bi-chevron-right');
        });
    }
    
    // Toggle switches
    const toggleSwitches = document.querySelectorAll('.toggle-switch');
    toggleSwitches.forEach(toggle => {
        toggle.addEventListener('click', () => {
            const setting = toggle.getAttribute('data-setting');
            
            // Handle special settings that need server updates
            if (setting === 'chat') {
                toggleChatSetting(toggle);
            } else {
                // Regular toggle for other settings
                toggle.classList.toggle('active');
            }
        });
    });
    
    // Quality option selection
    const qualityOptions = document.querySelectorAll('.quality-option');
    qualityOptions.forEach(option => {
        option.addEventListener('click', () => {
            qualityOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            const radio = option.querySelector('.quality-radio');
            if (radio) radio.checked = true;
        });
    });
    
    // Real-time updates for live streams
    {% if stream.status == 'live' %}
        setInterval(updateStreamStats, 30000); // Update every 30 seconds
    {% endif %}
});

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
            btn.innerHTML = originalHtml;
        }, 1500);
    });
}

function updateStreamStats() {
    fetch(`{% url "streaming:stream_status_api" stream.stream_id %}`)
        .then(response => response.json())
        .then(data => {
            if (data.viewer_count !== undefined) {
                const viewerElements = document.querySelectorAll('[id*="viewer"], .viewer-count span');
                viewerElements.forEach(el => {
                    if (el.textContent.includes('人が視聴中')) {
                        el.textContent = `${data.viewer_count} 人が視聴中`;
                    }
                });
            }
        })
        .catch(error => console.log('Stats update failed:', error));
}

function toggleEditMode() {
    alert('編集機能は現在開発中です。近日中に実装予定です。');
}

function toggleChatSetting(toggle) {
    const isCurrentlyActive = toggle.classList.contains('active');
    
    // Optimistic UI update
    toggle.classList.toggle('active');
    
    fetch(`/api/chat/api/toggle/{{ stream.stream_id }}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Chat setting updated:', data.chat_enabled);
            // UI is already updated optimistically
        } else {
            // Revert on failure
            if (isCurrentlyActive) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            alert('チャット設定の更新に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('Chat toggle error:', error);
        // Revert on error
        if (isCurrentlyActive) {
            toggle.classList.add('active');
        } else {
            toggle.classList.remove('active');
        }
        alert('チャット設定の更新に失敗しました');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function deleteStream() {
    if (confirm('この配信を削除しますか？この操作は元に戻せません。')) {
        window.location.href = `{% url "streaming:delete_stream" stream.stream_id %}`;
    }
}

// OBS オーバーレイ関連機能
function generateObsToken() {
    fetch(`{% url 'streaming:generate_obs_token' stream.stream_id %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ページをリロードして新しいURLを表示
            alert('OBS用URLを生成しました！');
            window.location.reload();
        } else {
            alert('URL生成に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('OBS token generation error:', error);
        alert('URL生成に失敗しました');
    });
}

function testObsOverlay(mode) {
    let obsUrl;
    if (mode === 'anonymous') {
        obsUrl = document.getElementById('obs-overlay-url-anonymous').value;
    } else {
        obsUrl = document.getElementById('obs-overlay-url-normal').value;
    }
    
    if (obsUrl && obsUrl !== 'URLを生成してください') {
        // すでにanonymousパラメータが含まれているので、debugパラメータを追加
        const separator = obsUrl.includes('?') ? '&' : '?';
        window.open(obsUrl + separator + 'debug=true', '_blank');
    } else {
        alert('まずURLを生成してください');
    }
}

// Chat Management Functions
let chatRefreshInterval = null;
let chatMessages = [];
let uniqueUsers = new Set();

function loadChatMessages() {
    fetch(`/api/chat/history/{{ stream.stream_id }}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.messages) {
            chatMessages = data.messages;
            displayChatMessages();
            updateChatStatistics();
        }
    })
    .catch(error => {
        console.error('Error loading chat messages:', error);
    });
}

function displayChatMessages() {
    const container = document.getElementById('chat-messages-container');
    if (!container) return;
    
    if (chatMessages.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted p-4">
                <i class="bi bi-chat-dots" style="font-size: 36px;"></i>
                <p class="mt-2">まだメッセージがありません</p>
            </div>
        `;
        updateChatStatistics();
        return;
    }
    
    container.innerHTML = '';
    uniqueUsers.clear();
    
    chatMessages.forEach(msg => {
        uniqueUsers.add(msg.username);
        const messageEl = document.createElement('div');
        messageEl.className = `chat-message${msg.is_pinned ? ' pinned' : ''}`;
        messageEl.dataset.messageId = msg.id;
        
        const isPinned = msg.is_pinned ? '<i class="bi bi-pin-angle-fill text-primary me-1"></i>' : '';
        
        messageEl.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center">
                        ${isPinned}
                        <strong class="me-2">${msg.username}</strong>
                        <small class="text-muted">${new Date(msg.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}</small>
                    </div>
                    <div class="mt-1">${msg.message}</div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="togglePin(${msg.id})">
                            <i class="bi bi-pin${msg.is_pinned ? '-fill' : ''} me-2"></i>${msg.is_pinned ? 'ピン解除' : 'ピン留め'}
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteMessage(${msg.id})">
                            <i class="bi bi-trash me-2"></i>削除
                        </a></li>
                    </ul>
                </div>
            </div>
        `;
        
        container.appendChild(messageEl);
    });
    
    // Update statistics
    updateChatStatistics();
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

function updateChatStatistics() {
    document.getElementById('total-messages').textContent = chatMessages.length;
    document.getElementById('active-users').textContent = uniqueUsers.size;
    
    const deletedCount = chatMessages.filter(msg => msg.is_deleted).length;
    document.getElementById('deleted-messages').textContent = deletedCount;
    
    const pinnedCount = chatMessages.filter(msg => msg.is_pinned).length;
    document.getElementById('pinned-messages').textContent = pinnedCount;
}

function togglePin(messageId) {
    fetch(`/api/chat/moderate/${messageId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'action=pin',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadChatMessages();
        } else {
            alert('操作に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('Error toggling pin:', error);
    });
}

function deleteMessage(messageId) {
    if (!confirm('このメッセージを削除しますか？')) return;
    
    fetch(`/api/chat/moderate/${messageId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'action=delete',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadChatMessages();
        } else {
            alert('削除に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('Error deleting message:', error);
    });
}

// Chat management event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Load chat messages when chat tab is opened
    const chatTab = document.querySelector('[data-tab="chat-management"]');
    if (chatTab) {
        const originalClickHandler = chatTab.onclick;
        chatTab.onclick = function(e) {
            if (originalClickHandler) originalClickHandler.call(this, e);
            loadChatMessages();
            
            // Start auto-refresh if enabled
            const autoRefresh = document.getElementById('auto-refresh-chat');
            if (autoRefresh && autoRefresh.checked) {
                startChatAutoRefresh();
            }
        };
    }
    
    // Refresh button - now refreshes both chat messages and moderation data
    const refreshBtn = document.getElementById('refresh-chat');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            loadChatMessages();
            refreshModerationData();
        });
    }
    
    // Auto-refresh toggle
    const autoRefreshToggle = document.getElementById('auto-refresh-chat');
    if (autoRefreshToggle) {
        autoRefreshToggle.addEventListener('change', function() {
            if (this.checked) {
                startChatAutoRefresh();
            } else {
                stopChatAutoRefresh();
            }
        });
    }
    
});

function startChatAutoRefresh() {
    stopChatAutoRefresh();
    chatRefreshInterval = setInterval(loadChatMessages, 5000); // Refresh every 5 seconds
}

function stopChatAutoRefresh() {
    if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
    }
}

// Moderation Functions
function addBannedWords() {
    const wordsInput = document.getElementById('banned-words-input');
    const words = wordsInput.value.trim();
    
    if (!words) {
        alert('NGワードを入力してください');
        return;
    }
    
    fetch(`/api/chat/banned-words/{{ stream.stream_id }}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ words: words }),
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            wordsInput.value = '';
            loadBannedWords();
            alert(data.message);
        } else {
            alert('NGワード追加に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('Error adding banned words:', error);
        alert('NGワード追加に失敗しました');
    });
}

function loadBannedWords() {
    fetch(`/api/chat/banned-words/{{ stream.stream_id }}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('current-banned-words');
        
        if (data.banned_words && data.banned_words.length > 0) {
            container.innerHTML = '';
            data.banned_words.forEach(word => {
                const wordEl = document.createElement('span');
                wordEl.className = 'badge bg-secondary me-1 mb-1 d-inline-flex align-items-center';
                wordEl.style.fontSize = '10px';
                wordEl.innerHTML = `
                    ${word.word}
                    <button class="btn btn-sm ms-1 p-0 border-0 bg-transparent" onclick="removeBannedWord(${word.id})" title="削除">
                        <i class="bi bi-x text-white" style="font-size: 12px;"></i>
                    </button>
                `;
                container.appendChild(wordEl);
            });
        } else {
            container.innerHTML = '<div class="text-muted small">NGワードなし</div>';
        }
    })
    .catch(error => {
        console.error('Error loading banned words:', error);
        document.getElementById('current-banned-words').innerHTML = 
            '<div class="text-danger small">読み込みエラー</div>';
    });
}

function removeBannedWord(wordId) {
    if (!confirm('このNGワードを削除しますか？')) return;
    
    fetch(`/api/chat/banned-words/remove/${wordId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadBannedWords();
            alert(data.message);
        } else {
            alert('削除に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('Error removing banned word:', error);
        alert('削除に失敗しました');
    });
}

function timeoutUsers() {
    const usernames = document.getElementById('timeout-usernames').value.trim();
    const duration = parseInt(document.getElementById('timeout-duration').value);
    
    if (!usernames) {
        alert('ユーザー名を入力してください');
        return;
    }
    
    // カンマ区切りでユーザー名を分割
    const usernameList = usernames.split(',').map(name => name.trim()).filter(name => name);
    
    if (usernameList.length === 0) {
        alert('有効なユーザー名を入力してください');
        return;
    }
    
    // 複数ユーザーのタイムアウトを並行実行
    const timeoutPromises = usernameList.map(username => {
        return fetch(`/api/chat/timeout/{{ stream.stream_id }}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                username: username, 
                duration: duration,
                reason: 'Manual timeout by streamer'
            }),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => ({ username, success: data.success, message: data.message, error: data.error }));
    });
    
    Promise.all(timeoutPromises)
    .then(results => {
        const successful = results.filter(r => r.success);
        const failed = results.filter(r => !r.success);
        
        let message = '';
        if (successful.length > 0) {
            message += `${successful.length}人のユーザーをタイムアウトしました\n`;
        }
        if (failed.length > 0) {
            message += `${failed.length}人のタイムアウトに失敗しました:\n`;
            failed.forEach(f => {
                message += `- ${f.username}: ${f.error}\n`;
            });
        }
        
        document.getElementById('timeout-usernames').value = '';
        loadActiveTimeouts();
        alert(message);
    })
    .catch(error => {
        console.error('Error timing out users:', error);
        alert('タイムアウト実行に失敗しました');
    });
}

function loadActiveTimeouts() {
    fetch(`/api/chat/timeouts/{{ stream.stream_id }}/`, {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('active-timeouts');
        
        if (data.timeouts && data.timeouts.length > 0) {
            let html = '';
            data.timeouts.forEach(timeout => {
                const expiresAt = new Date(timeout.expires_at);
                const now = new Date();
                const remainingMinutes = Math.ceil((expiresAt - now) / (1000 * 60));
                
                html += `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <div>
                            <strong>${timeout.username}</strong>
                            <div class="text-muted small">${timeout.reason}</div>
                            <div class="text-muted small">残り ${remainingMinutes} 分</div>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="removeTimeout(${timeout.id})">
                            解除
                        </button>
                    </div>
                `;
            });
            container.innerHTML = html;
        } else {
            container.innerHTML = '<div class="text-muted small">タイムアウト中のユーザーはいません</div>';
        }
    })
    .catch(error => {
        console.error('Error loading timeouts:', error);
        const container = document.getElementById('active-timeouts');
        container.innerHTML = '<div class="text-danger small">タイムアウトの読み込みに失敗しました</div>';
    });
}

function removeTimeout(timeoutId) {
    if (!confirm('このタイムアウトを解除しますか？')) return;
    
    fetch(`/api/chat/timeout/remove/${timeoutId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadActiveTimeouts();
            alert(data.message);
        } else {
            alert('タイムアウト解除に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('Error removing timeout:', error);
        alert('タイムアウト解除に失敗しました');
    });
}

function refreshModerationData() {
    loadBannedWords();
    loadActiveTimeouts();
}

// Load moderation data when chat management tab is opened
document.addEventListener('DOMContentLoaded', function() {
    const chatTab = document.querySelector('[data-tab="chat-management"]');
    if (chatTab) {
        const originalClickHandler = chatTab.onclick;
        chatTab.onclick = function(e) {
            if (originalClickHandler) originalClickHandler.call(this, e);
            
            // Load moderation data
            setTimeout(() => {
                refreshModerationData();
            }, 100);
        };
    }
});

// 管理操作機能
function exportModerationLog() {
    // モデレーションログをCSV形式でエクスポート
    const streamId = '{{ stream.stream_id }}';
    const currentDate = new Date().toISOString().split('T')[0];
    
    // 現在のNGワードとタイムアウトデータを収集
    Promise.all([
        fetch(`/api/chat/banned-words/${streamId}/`, { credentials: 'same-origin' }),
        fetch(`/api/chat/timeouts/${streamId}/`, { credentials: 'same-origin' })
    ])
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(([bannedWordsData, timeoutsData]) => {
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // ヘッダー
        csvContent += "種別,内容,作成日時,ステータス\n";
        
        // NGワード
        if (bannedWordsData.banned_words) {
            bannedWordsData.banned_words.forEach(word => {
                csvContent += `NGワード,"${word.word}","${word.created_at}",アクティブ\n`;
            });
        }
        
        // タイムアウト
        if (timeoutsData.timeouts) {
            timeoutsData.timeouts.forEach(timeout => {
                const expiresAt = new Date(timeout.expires_at).toLocaleString('ja-JP');
                csvContent += `タイムアウト,"${timeout.username} (${timeout.duration}分)","${timeout.created_at}","${expiresAt}まで"\n`;
            });
        }
        
        // ダウンロード
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `moderation_log_${currentDate}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert('モデレーションログをダウンロードしました');
    })
    .catch(error => {
        console.error('Error exporting log:', error);
        alert('ログの出力に失敗しました');
    });
}

</script>
{% endblock %}