{% load static %}

<!-- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ -->
<div class="reaction-widget">
    <!-- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ãƒ‘ãƒãƒ« -->
    <div class="reaction-buttons-panel bg-white rounded shadow-sm p-3 mb-3" style="border: 1px solid #e5e5e5;">
        <div class="d-flex justify-content-center align-items-center">
            <small class="me-3 text-muted fw-bold">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</small>
            <div class="reaction-buttons d-flex gap-2">
                <!-- SVGã‚¹ã‚¿ãƒ³ãƒ—ãƒœã‚¿ãƒ³ã¯å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰ -->
            </div>
        </div>
    </div>

    <!-- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¨ãƒªã‚¢ -->
    <div class="reaction-effects-area" id="reaction-effects">
        <!-- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã“ã“ã«è¡¨ç¤º -->
    </div>
</div>

<!-- CSS -->
<style>
.reaction-widget {
    position: relative;
}

.reaction-buttons button {
    width: 48px;
    height: 48px;
    border: 2px solid #e5e5e5;
    border-radius: 50%;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.reaction-buttons button:hover {
    transform: scale(1.1);
    border-color: #007bff;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

.reaction-buttons button:active {
    transform: scale(0.95);
}

.reaction-buttons button img,
.reaction-buttons button svg {
    width: 28px;
    height: 28px;
    object-fit: contain;
}

/* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¨ãƒªã‚¢ */
.reaction-effects-area {
    position: absolute;
    top: -200px;
    left: 0;
    right: 0;
    height: 200px;
    overflow: hidden;
    pointer-events: none;
    z-index: 10;
}

/* æµã‚Œã‚‹ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes floatUp {
    0% {
        opacity: 1;
        transform: translateY(0) rotate(0deg) scale(1);
    }
    50% {
        opacity: 0.8;
        transform: translateY(-50px) rotate(180deg) scale(1.2);
    }
    100% {
        opacity: 0;
        transform: translateY(-150px) rotate(360deg) scale(0.5);
    }
}

.floating-reaction {
    position: absolute;
    animation: floatUp 3s ease-out forwards;
    pointer-events: none;
    z-index: 15;
}

.floating-reaction img,
.floating-reaction svg {
    width: 32px;
    height: 32px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

/* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµ±è¨ˆè¡¨ç¤º */
.reaction-stats {
    position: absolute;
    bottom: -40px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 12px;
    display: none;
}

.reaction-stats.show {
    display: block;
    animation: fadeInOut 2s ease;
}

@keyframes fadeInOut {
    0%, 100% { opacity: 0; }
    50% { opacity: 1; }
}
</style>

<!-- JavaScript -->
<script>
let reactionSocket = null;
let availableReactions = [];
let reactionCounts = {};

// ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½åˆæœŸåŒ–
function initializeReactions() {
    // WebSocketæ¥ç¶š
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = protocol + '//' + window.location.host + '/ws/reactions/{{ video.stream_id }}/';
    
    reactionSocket = new WebSocket(wsUrl);
    
    reactionSocket.onopen = function(e) {
        console.log('ğŸ‰ Reaction WebSocket connected');
    };
    
    reactionSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'reaction') {
            showFloatingReaction(data.stamp_id, data.stamp_image_url, data.username);
            updateReactionStats(data.stamp_id);
        }
    };
    
    reactionSocket.onclose = function(e) {
        console.log('âŒ Reaction WebSocket disconnected');
        // å†æ¥ç¶šã‚’è©¦è¡Œ
        setTimeout(initializeReactions, 3000);
    };
    
    reactionSocket.onerror = function(e) {
        console.error('ğŸš¨ Reaction WebSocket error:', e);
    };
    
    // ã‚¹ã‚¿ãƒ³ãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
    loadAvailableReactions();
}

// åˆ©ç”¨å¯èƒ½ãªãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¹ã‚¿ãƒ³ãƒ—ï¼‰ã‚’ãƒ­ãƒ¼ãƒ‰
function loadAvailableReactions() {
    fetch('/api/chat/stamps/', {
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.stamps) {
            availableReactions = data.stamps;
            renderReactionButtons();
        }
    })
    .catch(error => console.error('Failed to load reactions:', error));
}

// ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’æç”»
function renderReactionButtons() {
    const buttonsContainer = document.querySelector('.reaction-buttons');
    if (!buttonsContainer) return;
    
    buttonsContainer.innerHTML = '';
    
    availableReactions.forEach(reaction => {
        const button = document.createElement('button');
        button.className = 'btn';
        button.title = `${reaction.name} ã§ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³`;
        button.onclick = () => sendReaction(reaction.id, reaction.name, reaction.image_url);
        
        if (reaction.image_url) {
            if (reaction.image_url.endsWith('.svg')) {
                // SVGãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                button.innerHTML = `<img src="${reaction.image_url}" alt="${reaction.name}" />`;
            } else {
                button.innerHTML = `<img src="${reaction.image_url}" alt="${reaction.name}" />`;
            }
        } else {
            button.innerHTML = reaction.name;
        }
        
        buttonsContainer.appendChild(button);
    });
}

// ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€ä¿¡
function sendReaction(stampId, stampName, stampImageUrl) {
    if (!reactionSocket || reactionSocket.readyState !== WebSocket.OPEN) {
        console.error('WebSocket not connected');
        return;
    }
    
    // è‡ªåˆ†ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å³åº§ã«è¡¨ç¤º
    showFloatingReaction(stampId, stampImageUrl, '{{ user.username }}');
    
    // WebSocketã§ä»–ã®è¦–è´è€…ã«é€ä¿¡
    reactionSocket.send(JSON.stringify({
        'type': 'stream_reaction',
        'stamp_id': stampId,
        'stamp_name': stampName,
        'stamp_image_url': stampImageUrl,
        'stream_id': '{{ video.stream_id }}'
    }));
}

// æµã‚Œã‚‹ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
function showFloatingReaction(stampId, stampImageUrl, username) {
    const effectsArea = document.getElementById('reaction-effects');
    if (!effectsArea) return;
    
    const reaction = document.createElement('div');
    reaction.className = 'floating-reaction';
    
    // ãƒ©ãƒ³ãƒ€ãƒ ãªé–‹å§‹ä½ç½®
    const startX = Math.random() * 80 + 10; // 10% - 90%ã®ç¯„å›²
    reaction.style.left = startX + '%';
    
    // ãƒ©ãƒ³ãƒ€ãƒ ãªé…å»¶ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“
    const delay = Math.random() * 0.5; // 0-0.5ç§’ã®é…å»¶
    const duration = 2.5 + Math.random() * 1; // 2.5-3.5ç§’ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    
    reaction.style.animationDelay = delay + 's';
    reaction.style.animationDuration = duration + 's';
    
    if (stampImageUrl) {
        reaction.innerHTML = `<img src="${stampImageUrl}" alt="reaction" />`;
    } else {
        reaction.innerHTML = 'â¤ï¸'; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    }
    
    effectsArea.appendChild(reaction);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«è¦ç´ ã‚’å‰Šé™¤
    setTimeout(() => {
        if (reaction.parentNode) {
            reaction.parentNode.removeChild(reaction);
        }
    }, (delay + duration) * 1000 + 100);
}

// ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµ±è¨ˆã‚’æ›´æ–°
function updateReactionStats(stampId) {
    if (!reactionCounts[stampId]) {
        reactionCounts[stampId] = 0;
    }
    reactionCounts[stampId]++;
    
    // çµ±è¨ˆè¡¨ç¤ºã‚¨ãƒªã‚¢ã®æ›´æ–°ï¼ˆé…ä¿¡è€…ç”¨ï¼‰
    updateReactionStatsDisplay();
}

function updateReactionStatsDisplay() {
    // TODO: é…ä¿¡è€…ç”¨ã®çµ±è¨ˆè¡¨ç¤ºã‚’å®Ÿè£…
    console.log('Current reaction counts:', reactionCounts);
}

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    {% if video.is_live and user.is_authenticated %}
        initializeReactions();
    {% endif %}
});

// ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«WebSocketæ¥ç¶šã‚’é–‰ã˜ã‚‹
window.addEventListener('beforeunload', function() {
    if (reactionSocket) {
        reactionSocket.close();
    }
});
</script>