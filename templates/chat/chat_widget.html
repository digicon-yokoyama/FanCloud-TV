{% load static %}

<!-- ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ -->
{% if show_chat and video.is_live and video.enable_chat %}
<div class="chat-widget">
    <div class="chat-container mb-4 position-relative" style="display: block !important; visibility: visible !important; height: auto !important; overflow: visible !important; min-height: 500px; border: 2px solid #007bff; background: #f8f9fa;">
        
        <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="chat-messages position-relative" id="chat-messages" style="height: 400px; overflow-y: auto; padding: 12px; background-color: #fafafa;">
            <!-- ä¸€æ™‚çš„ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢å†…ã®ä¸Šéƒ¨ï¼‰ -->
            <div id="temporary-reaction-area" class="temporary-reaction-area"></div>
            <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            <div class="chat-placeholder text-center text-muted py-4">
                <i class="bi bi-chat-dots"></i>
                <p class="mb-0">ãƒãƒ£ãƒƒãƒˆã§ãƒ©ã‚¤ãƒ–é…ä¿¡è€…ã‚„è¦–è´è€…ã¨äº¤æµã—ã¾ã—ã‚‡ã†ï¼</p>
            </div>
        </div>
        
        <!-- ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div class="chat-input-area" style="padding: 10px; border-top: 1px solid #ddd; background: #f9f9f9;">
            {% if user.is_authenticated %}
                <!-- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="reaction-buttons-area mb-2" id="reaction-buttons-area" style="display: none;">
                    <small class="text-muted me-2">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</small>
                    <div class="d-inline-flex gap-1" id="reaction-buttons">
                        <!-- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ãŒå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                    </div>
                </div>
                
                <div class="input-group">
                    <input type="text" class="form-control" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." maxlength="500" autocomplete="off">
                    <button class="btn btn-outline-secondary" type="button" id="reaction-toggle" title="ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³">
                        ğŸ˜Š
                    </button>
                    <button class="btn btn-primary" type="button" id="send-chat" disabled>
                        <i class="bi bi-send"></i>
                    </button>
                </div>
                <small class="text-muted">Enter ã§é€ä¿¡ â€¢ æœ€å¤§500æ–‡å­—</small>
            {% else %}
                <div class="text-center p-3">
                    <p class="text-muted mb-2">ãƒãƒ£ãƒƒãƒˆã«å‚åŠ ã™ã‚‹ã«ã¯<a href="{% url 'accounts:login' %}" class="text-decoration-none">ãƒ­ã‚°ã‚¤ãƒ³</a>ã—ã¦ãã ã•ã„</p>
                    <a href="{% url 'accounts:login' %}" class="btn btn-primary btn-sm">ãƒ­ã‚°ã‚¤ãƒ³</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½JavaScript -->
<script>
let chatSocket = null;
let reactionSocket = null;
let availableReactions = [];
let reactionPanelVisible = false;

function testWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const testUrl = protocol + '//' + window.location.host + '/ws/test/';
    console.log('ğŸ§ª WS TEST: Connecting to:', testUrl);

    const testSocket = new WebSocket(testUrl);

    testSocket.onopen = function(e) {
        console.log('ğŸ§ª WS TEST: Connected successfully');
    };

    testSocket.onmessage = function(e) {
        console.log('ğŸ§ª WS TEST: Received message:', e.data);
    };

    testSocket.onclose = function(e) {
        console.log('ğŸ§ª WS TEST: Connection closed');
    };

    testSocket.onerror = function(e) {
        console.error('ğŸ§ª WS TEST: Error:', e);
    };
}

function testSimpleChat() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const simpleChatUrl = protocol + '//' + window.location.host + '/ws/simple_chat/{{ video.stream_id }}/';
    console.log('ğŸ”Œ WS SIMPLE TEST: Connecting to:', simpleChatUrl);

    const simpleSocket = new WebSocket(simpleChatUrl);

    simpleSocket.onopen = function(e) {
        console.log('ğŸ”Œ WS SIMPLE TEST: Connected successfully');
    };

    simpleSocket.onmessage = function(e) {
        console.log('ğŸ”Œ WS SIMPLE TEST: Received message:', e.data);
    };

    simpleSocket.onclose = function(e) {
        console.log('ğŸ”Œ WS SIMPLE TEST: Connection closed');
    };

    simpleSocket.onerror = function(e) {
        console.error('ğŸ”Œ WS SIMPLE TEST: Error:', e);
    };
}

function initializeChat() {
    // è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆæ¥ç¶šã‚’è©¦ã™
    console.log('ğŸ§ª Starting WebSocket tests...');
    testWebSocket();
    testSimpleChat();

    if (!chatSocket) {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = protocol + '//' + window.location.host + '/ws/chat/{{ video.stream_id }}/';
        console.log('ğŸ”Œ WS: Connecting to:', wsUrl);

        chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = function(e) {
            console.log('ğŸ”Œ WS: Connected successfully');
            document.getElementById('send-chat').disabled = false;
        };
        
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.error) {
                showChatError(data.error);
                return;
            }
            
            if (data.type === 'reaction') {
                showTemporaryReaction(data);
                return;
            }
            
            addMessageToChat(data);
        };
        
        chatSocket.onclose = function(e) {
            document.getElementById('send-chat').disabled = true;
            chatSocket = null;
        };
        
        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
        };
    }
}

function sendMessage() {
    const messageInput = document.getElementById('chat-input');
    const message = messageInput.value.trim();
    
    if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        
        messageInput.value = '';
    }
}

function addMessageToChat(data) {
    const messagesContainer = document.getElementById('chat-messages');
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå­˜åœ¨ã—ãªã„å ´åˆã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’éè¡¨ç¤º
    const placeholder = messagesContainer.querySelector('.chat-placeholder');
    if (placeholder) {
        placeholder.style.display = 'none';
    }
    
    const messageElement = document.createElement('div');
    messageElement.className = 'chat-message mb-2 p-2 rounded';
    
    // ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªå–å¾—
    const messageContent = data.message || data.content || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ãªã—';
    const username = data.username || 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼';
    const messageType = data.message_type || 'message';
    
    if (messageType === 'join' || messageType === 'leave') {
        messageElement.className += ' bg-light text-muted small';
        messageElement.innerHTML = `<i class="bi bi-info-circle me-1"></i>${messageContent}`;
    } else {
        messageElement.className += ' bg-white border';
        
        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®å‡¦ç†
        let timestamp;
        if (data.timestamp) {
            timestamp = new Date(data.timestamp).toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        } else {
            timestamp = new Date().toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        messageElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <strong class="text-primary">${username}</strong>
                    <div class="message-content">${messageContent}</div>
                </div>
                <small class="text-muted">${timestamp}</small>
            </div>
        `;
        
        messageElement.dataset.messageId = data.id || Date.now();
    }
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// ãƒ©ã‚¤ãƒ–é…ä¿¡é¢¨ã®ä¸€æ™‚çš„ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
function showTemporaryReaction(data) {
    const reactionArea = document.getElementById('temporary-reaction-area');
    if (!reactionArea) return;
    
    const username = data.username || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
    const stampImage = data.stamp_image_url ? 
        `<img src="${data.stamp_image_url}" alt="${data.stamp_name}" style="width: 24px; height: 24px;">` : 
        (data.stamp_name || 'â¤ï¸');
    
    // ä¸€æ™‚çš„ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¦ç´ ã‚’ä½œæˆ
    const reactionElement = document.createElement('div');
    reactionElement.className = 'floating-reaction';
    
    // ãƒ©ãƒ³ãƒ€ãƒ ãªé–‹å§‹ä½ç½®ï¼ˆæ¨ªæ–¹å‘ï¼‰
    const startX = Math.random() * 70 + 15; // 15%-85%ã®ç¯„å›²
    reactionElement.style.left = startX + '%';
    
    // ãƒ©ãƒ³ãƒ€ãƒ ãªé…å»¶ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“
    const delay = Math.random() * 0.5; // 0-0.5ç§’ã®é…å»¶
    const duration = 3 + Math.random() * 1; // 3-4ç§’ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    
    reactionElement.style.animationDelay = delay + 's';
    reactionElement.style.animationDuration = duration + 's';
    
    reactionElement.innerHTML = `
        <div class="reaction-content d-flex align-items-center">
            ${stampImage}
            <small class="ms-1 text-white fw-bold" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">${username}</small>
        </div>
    `;
    
    reactionArea.appendChild(reactionElement);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«è¦ç´ ã‚’å‰Šé™¤
    setTimeout(() => {
        if (reactionElement.parentNode) {
            reactionElement.parentNode.removeChild(reactionElement);
        }
    }, (delay + duration) * 1000 + 100);
}

// ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’èª­ã¿è¾¼ã¿
function loadReactionButtons() {
    fetch('/api/chat/stamps/', {
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.stamps) {
            availableReactions = data.stamps;
            renderReactionButtons();
        }
    })
    .catch(error => console.error('Failed to load reactions:', error));
}

// ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’æç”»
function renderReactionButtons() {
    const buttonsContainer = document.getElementById('reaction-buttons');
    if (!buttonsContainer) return;
    
    buttonsContainer.innerHTML = '';
    
    availableReactions.forEach(reaction => {
        const button = document.createElement('button');
        button.className = 'btn btn-sm btn-outline-secondary reaction-btn';
        button.style.cssText = 'width: 36px; height: 36px; padding: 2px; border-radius: 50%;';
        button.title = reaction.name;
        button.onclick = () => sendReaction(reaction);
        
        if (reaction.image_url) {
            button.innerHTML = `<img src="${reaction.image_url}" alt="${reaction.name}" style="width: 24px; height: 24px;">`;
        } else {
            button.innerHTML = reaction.name;
        }
        
        buttonsContainer.appendChild(button);
    });
}

// ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡
function sendReaction(reaction) {
    if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
        console.error('WebSocket not connected');
        return;
    }
    
    chatSocket.send(JSON.stringify({
        'type': 'reaction',
        'stamp_id': reaction.id,
        'stamp_name': reaction.name,
        'stamp_image_url': reaction.image_url
    }));
    
    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ«ã‚’éš ã™
    toggleReactionPanel();
}

// ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ«è¡¨ç¤ºåˆ‡æ›¿
function toggleReactionPanel() {
    const panel = document.getElementById('reaction-buttons-area');
    if (!panel) return;
    
    reactionPanelVisible = !reactionPanelVisible;
    panel.style.display = reactionPanelVisible ? 'block' : 'none';
    
    if (reactionPanelVisible && availableReactions.length === 0) {
        loadReactionButtons();
    }
}



function showChatError(error) {
    const messagesContainer = document.getElementById('chat-messages');
    const errorElement = document.createElement('div');
    errorElement.className = 'chat-error alert alert-danger mb-2';
    errorElement.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i>${error}`;
    
    messagesContainer.appendChild(errorElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function loadChatHistory() {
    fetch(`/api/chat/history/{{ video.stream_id }}/`, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(message => {
                addMessageToChat({
                    id: message.id,
                    username: message.username,
                    message: message.message || message.content,
                    content: message.content || message.message,
                    message_type: message.message_type,
                    timestamp: message.timestamp
                });
            });
        }
    })
    .catch(error => {
        console.error('Failed to load chat history:', error);
    });
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
document.addEventListener('DOMContentLoaded', function() {
    
    // ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–
    initializeChat();
    loadChatHistory();
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    const sendButton = document.getElementById('send-chat');
    if (sendButton) {
        sendButton.addEventListener('click', sendMessage);
    }
    
    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    const reactionToggle = document.getElementById('reaction-toggle');
    if (reactionToggle) {
        reactionToggle.addEventListener('click', toggleReactionPanel);
    }
    
    // Enter ã‚­ãƒ¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // å…¥åŠ›æ™‚ã®é€ä¿¡ãƒœã‚¿ãƒ³çŠ¶æ…‹ç®¡ç†
        chatInput.addEventListener('input', function() {
            const sendBtn = document.getElementById('send-chat');
            if (sendBtn) {
                sendBtn.disabled = !this.value.trim() || !chatSocket || chatSocket.readyState !== WebSocket.OPEN;
            }
        });
    }
});

// ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«WebSocketæ¥ç¶šã‚’é–‰ã˜ã‚‹
window.addEventListener('beforeunload', function() {
    if (chatSocket) {
        chatSocket.close();
    }
});
</script>

{% else %}
<!-- ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ãŒç„¡åŠ¹ãªå ´åˆ -->
<div class="chat-disabled text-center p-4 bg-light rounded">
    <i class="bi bi-chat-square-x text-muted" style="font-size: 2rem;"></i>
    <p class="text-muted mb-0 mt-2">
        {% if not video.is_live %}
            é…ä¿¡ãŒé–‹å§‹ã•ã‚Œã‚‹ã¨ãƒãƒ£ãƒƒãƒˆãŒåˆ©ç”¨ã§ãã¾ã™
        {% elif not video.enable_chat %}
            ã“ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§ã¯ãƒãƒ£ãƒƒãƒˆãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™
        {% else %}
            ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“
        {% endif %}
    </p>
</div>
{% endif %}