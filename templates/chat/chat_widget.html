{% load static %}

<!-- チャット機能ウィジェット -->
{% if show_chat and video.is_live and video.enable_chat %}
<div class="chat-widget">
    <div class="chat-container mb-4" style="display: block !important; visibility: visible !important; height: auto !important; overflow: visible !important; min-height: 500px; border: 2px solid #007bff; background: #f8f9fa;">
        
        
        <!-- チャットメッセージ表示エリア -->
        <div class="chat-messages" id="chat-messages" style="height: 400px; overflow-y: auto; padding: 12px; background-color: #fafafa;">
            <!-- チャットメッセージがここに表示されます -->
            <div class="chat-placeholder text-center text-muted py-4">
                <i class="bi bi-chat-dots"></i>
                <p class="mb-0">チャットでライブ配信者や視聴者と交流しましょう！</p>
            </div>
        </div>
        
        <!-- チャット入力エリア -->
        <div class="chat-input-area" style="padding: 10px; border-top: 1px solid #ddd; background: #f9f9f9;">
            {% if user.is_authenticated %}
                <div class="input-group">
                    <input type="text" class="form-control" id="chat-input" placeholder="メッセージを入力..." maxlength="500" autocomplete="off">
                    <button class="btn btn-primary" type="button" id="send-chat" disabled>
                        <i class="bi bi-send"></i>
                    </button>
                </div>
                <small class="text-muted">Enter で送信 • 最大500文字</small>
            {% else %}
                <div class="text-center p-3">
                    <p class="text-muted mb-2">チャットに参加するには<a href="{% url 'accounts:login' %}" class="text-decoration-none">ログイン</a>してください</p>
                    <a href="{% url 'accounts:login' %}" class="btn btn-primary btn-sm">ログイン</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- チャット機能JavaScript -->
<script>
let chatSocket = null;

function initializeChat() {
    if (!chatSocket) {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        chatSocket = new WebSocket(
            protocol + '//' + window.location.host + '/ws/chat/{{ video.stream_id }}/'
        );
        
        chatSocket.onopen = function(e) {
            document.getElementById('send-chat').disabled = false;
        };
        
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.error) {
                showChatError(data.error);
                return;
            }
            
            addMessageToChat(data);
        };
        
        chatSocket.onclose = function(e) {
            document.getElementById('send-chat').disabled = true;
            chatSocket = null;
        };
        
        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
        };
    }
}

function sendMessage() {
    const messageInput = document.getElementById('chat-input');
    const message = messageInput.value.trim();
    
    if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        
        messageInput.value = '';
    }
}

function addMessageToChat(data) {
    const messagesContainer = document.getElementById('chat-messages');
    
    // メッセージが存在しない場合、プレースホルダーを非表示
    const placeholder = messagesContainer.querySelector('.chat-placeholder');
    if (placeholder) {
        placeholder.style.display = 'none';
    }
    
    const messageElement = document.createElement('div');
    messageElement.className = 'chat-message mb-2 p-2 rounded';
    
    // データの安全な取得
    const messageContent = data.message || data.content || 'メッセージ内容なし';
    const username = data.username || 'テストユーザー';
    const messageType = data.message_type || 'message';
    
    if (messageType === 'join' || messageType === 'leave') {
        messageElement.className += ' bg-light text-muted small';
        messageElement.innerHTML = `<i class="bi bi-info-circle me-1"></i>${messageContent}`;
    } else {
        messageElement.className += ' bg-white border';
        
        // タイムスタンプの処理
        let timestamp;
        if (data.timestamp) {
            timestamp = new Date(data.timestamp).toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        } else {
            timestamp = new Date().toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        messageElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong class="text-primary">${username}</strong>
                    <div class="message-content">${messageContent}</div>
                </div>
                <small class="text-muted">${timestamp}</small>
            </div>
        `;
    }
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showChatError(error) {
    const messagesContainer = document.getElementById('chat-messages');
    const errorElement = document.createElement('div');
    errorElement.className = 'chat-error alert alert-danger mb-2';
    errorElement.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i>${error}`;
    
    messagesContainer.appendChild(errorElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function loadChatHistory() {
    fetch(`/api/chat/history/{{ video.stream_id }}/`, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(message => {
                addMessageToChat({
                    username: message.username,
                    message: message.message || message.content,
                    content: message.content || message.message,
                    message_type: message.message_type,
                    timestamp: message.timestamp
                });
            });
        }
    })
    .catch(error => {
        console.error('Failed to load chat history:', error);
    });
}

// イベントリスナーの設定
document.addEventListener('DOMContentLoaded', function() {
    
    // チャット初期化
    initializeChat();
    loadChatHistory();
    
    // 送信ボタンのクリックイベント
    const sendButton = document.getElementById('send-chat');
    if (sendButton) {
        sendButton.addEventListener('click', sendMessage);
    }
    
    // Enter キーでメッセージ送信
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // 入力時の送信ボタン状態管理
        chatInput.addEventListener('input', function() {
            const sendBtn = document.getElementById('send-chat');
            if (sendBtn) {
                sendBtn.disabled = !this.value.trim() || !chatSocket || chatSocket.readyState !== WebSocket.OPEN;
            }
        });
    }
});

// ページ離脱時にWebSocket接続を閉じる
window.addEventListener('beforeunload', function() {
    if (chatSocket) {
        chatSocket.close();
    }
});
</script>

{% else %}
<!-- チャット機能が無効な場合 -->
<div class="chat-disabled text-center p-4 bg-light rounded">
    <i class="bi bi-chat-square-x text-muted" style="font-size: 2rem;"></i>
    <p class="text-muted mb-0 mt-2">
        {% if not video.is_live %}
            配信が開始されるとチャットが利用できます
        {% elif not video.enable_chat %}
            このストリームではチャットが無効になっています
        {% else %}
            チャット機能が利用できません
        {% endif %}
    </p>
</div>
{% endif %}