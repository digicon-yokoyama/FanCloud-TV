<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Authentication Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f0f0f0; padding: 10px; height: 300px; overflow-y: scroll; margin: 10px 0; }
        button { padding: 10px; margin: 5px; }
        input { padding: 5px; margin: 5px; width: 300px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>WebSocket認証テスト</h1>
    
    <div>
        <h3>接続状況</h3>
        <div id="status">未接続</div>
        <button onclick="connect()">接続</button>
        <button onclick="disconnect()">切断</button>
    </div>
    
    <div>
        <h3>メッセージ送信</h3>
        <input type="text" id="messageInput" placeholder="メッセージを入力">
        <button onclick="sendMessage()">送信</button>
    </div>
    
    <div>
        <h3>ログ</h3>
        <button onclick="clearLog()">ログクリア</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        let chatSocket = null;
        const roomName = 'test_room';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info');
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }
        
        function connect() {
            if (chatSocket) {
                log('既に接続されています', 'error');
                return;
            }
            
            // WebSocketのURLを正しく構築
            const wsScheme = 'ws';  // 開発環境では常にws
            const wsHost = 'localhost:8000';  // 明示的にホストを指定
            const wsPath = `${wsScheme}://${wsHost}/ws/chat/${roomName}/`;
            
            log(`接続試行: ${wsPath}`);
            updateStatus('接続中...');
            
            chatSocket = new WebSocket(wsPath);
            
            chatSocket.onopen = function(e) {
                log('WebSocket接続成功！', 'success');
                updateStatus('接続済み');
            };
            
            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                log(`受信: ${JSON.stringify(data, null, 2)}`, 'success');
                
                if (data.error) {
                    log(`エラー: ${data.error}`, 'error');
                }
                
                if (data.message_type === 'auth_error') {
                    log('認証エラーが発生しました。ログインしてからお試しください。', 'error');
                }
            };
            
            chatSocket.onclose = function(e) {
                log(`WebSocket切断 (code: ${e.code})`, 'error');
                updateStatus('切断済み');
                chatSocket = null;
            };
            
            chatSocket.onerror = function(e) {
                log('WebSocketエラー', 'error');
                updateStatus('エラー');
            };
        }
        
        function disconnect() {
            if (chatSocket) {
                chatSocket.close();
                chatSocket = null;
                updateStatus('切断済み');
                log('WebSocket切断');
            }
        }
        
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                log('メッセージを入力してください', 'error');
                return;
            }
            
            if (!chatSocket) {
                log('WebSocketに接続してください', 'error');
                return;
            }
            
            if (chatSocket.readyState !== WebSocket.OPEN) {
                log('WebSocket接続が確立されていません', 'error');
                return;
            }
            
            const data = {
                'message': message
            };
            
            log(`送信: ${message}`);
            chatSocket.send(JSON.stringify(data));
            messageInput.value = '';
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Enter keyでメッセージ送信
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // ページロード時の説明
        window.onload = function() {
            log('WebSocket認証テストページです');
            log('1. ブラウザで http://localhost:8000/accounts/login/ にアクセスしてログインしてください');
            log('2. このページに戻って「接続」ボタンをクリックしてください');
            log('3. メッセージを送信してテストしてください');
        };
    </script>
</body>
</html>
